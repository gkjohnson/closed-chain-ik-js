(function(){"use strict";var Ce=1e-6,$=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function Ee(){var e=new $(9);return $!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function Tt(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function ft(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function j(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],i=t[4],c=t[5],o=t[6],l=t[7],h=t[8],f=t[9],d=t[10],u=t[11],m=t[12],v=t[13],p=t[14],w=t[15],C=r*c-s*i,D=r*o-n*i,F=r*l-a*i,x=s*o-n*c,g=s*l-a*c,E=n*l-a*o,M=h*v-f*m,S=h*p-d*m,P=h*w-u*m,W=f*p-d*v,A=f*w-u*v,V=d*w-u*p,T=C*V-D*A+F*W+x*P-g*S+E*M;return T?(T=1/T,e[0]=(c*V-o*A+l*W)*T,e[1]=(n*A-s*V-a*W)*T,e[2]=(v*E-p*g+w*x)*T,e[3]=(d*g-f*E-u*x)*T,e[4]=(o*P-i*V-l*S)*T,e[5]=(r*V-n*P+a*S)*T,e[6]=(p*F-m*E-w*D)*T,e[7]=(h*E-d*F+u*D)*T,e[8]=(i*A-c*P+l*M)*T,e[9]=(s*P-r*A-a*M)*T,e[10]=(m*g-v*F+w*C)*T,e[11]=(f*F-h*g-u*C)*T,e[12]=(c*S-i*W-o*M)*T,e[13]=(r*W-s*S+n*M)*T,e[14]=(v*D-m*x-p*C)*T,e[15]=(h*x-f*D+d*C)*T,e):null}function N(e,t,r){var s=t[0],n=t[1],a=t[2],i=t[3],c=t[4],o=t[5],l=t[6],h=t[7],f=t[8],d=t[9],u=t[10],m=t[11],v=t[12],p=t[13],w=t[14],C=t[15],D=r[0],F=r[1],x=r[2],g=r[3];return e[0]=D*s+F*c+x*f+g*v,e[1]=D*n+F*o+x*d+g*p,e[2]=D*a+F*l+x*u+g*w,e[3]=D*i+F*h+x*m+g*C,D=r[4],F=r[5],x=r[6],g=r[7],e[4]=D*s+F*c+x*f+g*v,e[5]=D*n+F*o+x*d+g*p,e[6]=D*a+F*l+x*u+g*w,e[7]=D*i+F*h+x*m+g*C,D=r[8],F=r[9],x=r[10],g=r[11],e[8]=D*s+F*c+x*f+g*v,e[9]=D*n+F*o+x*d+g*p,e[10]=D*a+F*l+x*u+g*w,e[11]=D*i+F*h+x*m+g*C,D=r[12],F=r[13],x=r[14],g=r[15],e[12]=D*s+F*c+x*f+g*v,e[13]=D*n+F*o+x*d+g*p,e[14]=D*a+F*l+x*u+g*w,e[15]=D*i+F*h+x*m+g*C,e}function Qt(e,t,r){var s=t[0],n=t[1],a=t[2],i=t[3],c=s+s,o=n+n,l=a+a,h=s*c,f=s*o,d=s*l,u=n*o,m=n*l,v=a*l,p=i*c,w=i*o,C=i*l;return e[0]=1-(u+v),e[1]=f+C,e[2]=d-w,e[3]=0,e[4]=f-C,e[5]=1-(h+v),e[6]=m+p,e[7]=0,e[8]=d+w,e[9]=m-p,e[10]=1-(h+u),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function Z(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Me(e,t){var r=t[0],s=t[1],n=t[2],a=t[4],i=t[5],c=t[6],o=t[8],l=t[9],h=t[10];return e[0]=Math.hypot(r,s,n),e[1]=Math.hypot(a,i,c),e[2]=Math.hypot(o,l,h),e}function G(e,t){var r=new $(3);Me(r,t);var s=1/r[0],n=1/r[1],a=1/r[2],i=t[0]*s,c=t[1]*n,o=t[2]*a,l=t[4]*s,h=t[5]*n,f=t[6]*a,d=t[8]*s,u=t[9]*n,m=t[10]*a,v=i+h+m,p=0;return v>0?(p=Math.sqrt(v+1)*2,e[3]=.25*p,e[0]=(f-u)/p,e[1]=(d-o)/p,e[2]=(c-l)/p):i>h&&i>m?(p=Math.sqrt(1+i-h-m)*2,e[3]=(f-u)/p,e[0]=.25*p,e[1]=(c+l)/p,e[2]=(d+o)/p):h>m?(p=Math.sqrt(1+h-i-m)*2,e[3]=(d-o)/p,e[0]=(c+l)/p,e[1]=.25*p,e[2]=(f+u)/p):(p=Math.sqrt(1+m-i-h)*2,e[3]=(c-l)/p,e[0]=(d+o)/p,e[1]=(f+u)/p,e[2]=.25*p),e}function Ae(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],i=r+r,c=s+s,o=n+n,l=r*i,h=s*i,f=s*c,d=n*i,u=n*c,m=n*o,v=a*i,p=a*c,w=a*o;return e[0]=1-f-m,e[1]=h+w,e[2]=d-p,e[3]=0,e[4]=h-w,e[5]=1-l-m,e[6]=u+v,e[7]=0,e[8]=d+p,e[9]=u-v,e[10]=1-l-f,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Gt(){var e=new $(3);return $!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function dt(e){var t=e[0],r=e[1],s=e[2];return Math.hypot(t,r,s)}function Xt(e,t,r){var s=new $(3);return s[0]=e,s[1]=t,s[2]=r,s}function ut(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Yt(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function vt(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function Se(e,t){var r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return Math.hypot(r,s,n)}function Te(e,t){var r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return r*r+s*s+n*n}function Pe(e,t){var r=t[0],s=t[1],n=t[2],a=r*r+s*s+n*n;return a>0&&(a=1/Math.sqrt(a)),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a,e}function Ve(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Pt(e,t,r){var s=t[0],n=t[1],a=t[2],i=r[0],c=r[1],o=r[2];return e[0]=n*o-a*c,e[1]=a*i-s*o,e[2]=s*c-n*i,e}function We(e,t,r){var s=t[0],n=t[1],a=t[2],i=r[3]*s+r[7]*n+r[11]*a+r[15];return i=i||1,e[0]=(r[0]*s+r[4]*n+r[8]*a+r[12])/i,e[1]=(r[1]*s+r[5]*n+r[9]*a+r[13])/i,e[2]=(r[2]*s+r[6]*n+r[10]*a+r[14])/i,e}var Le=Te,Je=dt;(function(){var e=Gt();return function(t,r,s,n,a,i){var c,o;for(r||(r=3),s||(s=0),n?o=Math.min(n*r+s,t.length):o=t.length,c=s;c<o;c+=r)e[0]=t[c],e[1]=t[c+1],e[2]=t[c+2],a(e,e,i),t[c]=e[0],t[c+1]=e[1],t[c+2]=e[2];return t}})();function Re(){var e=new $(4);return $!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function Vt(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}function lt(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e}function Zt(e,t){var r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2],a=t[3]-e[3];return r*r+s*s+n*n+a*a}function ke(e){var t=e[0],r=e[1],s=e[2],n=e[3];return Math.hypot(t,r,s,n)}function Ue(e){var t=e[0],r=e[1],s=e[2],n=e[3];return t*t+r*r+s*s+n*n}function Ne(e,t){var r=t[0],s=t[1],n=t[2],a=t[3],i=r*r+s*s+n*n+a*a;return i>0&&(i=1/Math.sqrt(i)),e[0]=r*i,e[1]=s*i,e[2]=n*i,e[3]=a*i,e}(function(){var e=Re();return function(t,r,s,n,a,i){var c,o;for(r||(r=4),s||(s=0),n?o=Math.min(n*r+s,t.length):o=t.length,c=s;c<o;c+=r)e[0]=t[c],e[1]=t[c+1],e[2]=t[c+2],e[3]=t[c+3],a(e,e,i),t[c]=e[0],t[c+1]=e[1],t[c+2]=e[2],t[c+3]=e[3];return t}})();function Ot(){var e=new $(4);return $!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function qe(e,t,r){r=r*.5;var s=Math.sin(r);return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=Math.cos(r),e}function Wt(e,t,r,s){var n=t[0],a=t[1],i=t[2],c=t[3],o=r[0],l=r[1],h=r[2],f=r[3],d,u,m,v,p;return u=n*o+a*l+i*h+c*f,u<0&&(u=-u,o=-o,l=-l,h=-h,f=-f),1-u>Ce?(d=Math.acos(u),m=Math.sin(d),v=Math.sin((1-s)*d)/m,p=Math.sin(s*d)/m):(v=1-s,p=s),e[0]=v*n+p*o,e[1]=v*a+p*l,e[2]=v*i+p*h,e[3]=v*c+p*f,e}function ze(e,t){var r=t[0]+t[4]+t[8],s;if(r>0)s=Math.sqrt(r+1),e[3]=.5*s,s=.5/s,e[0]=(t[5]-t[7])*s,e[1]=(t[6]-t[2])*s,e[2]=(t[1]-t[3])*s;else{var n=0;t[4]>t[0]&&(n=1),t[8]>t[n*3+n]&&(n=2);var a=(n+1)%3,i=(n+2)%3;s=Math.sqrt(t[n*3+n]-t[a*3+a]-t[i*3+i]+1),e[n]=.5*s,s=.5/s,e[3]=(t[a*3+i]-t[i*3+a])*s,e[a]=(t[a*3+n]+t[n*3+a])*s,e[i]=(t[i*3+n]+t[n*3+i])*s}return e}function pt(e,t,r,s){var n=.5*Math.PI/180;t*=n,r*=n,s*=n;var a=Math.sin(t),i=Math.cos(t),c=Math.sin(r),o=Math.cos(r),l=Math.sin(s),h=Math.cos(s);return e[0]=a*o*h-i*c*l,e[1]=i*c*h+a*o*l,e[2]=i*o*l-a*c*h,e[3]=i*o*h+a*c*l,e}var Ht=Ne;(function(){var e=Gt(),t=Xt(1,0,0),r=Xt(0,1,0);return function(s,n,a){var i=Ve(n,a);return i<-.999999?(Pt(e,t,n),Je(e)<1e-6&&Pt(e,r,n),Pe(e,e),qe(s,e,Math.PI),s):i>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(Pt(e,n,a),s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1+i,Ht(s,s))}})(),function(){var e=Ot(),t=Ot();return function(r,s,n,a,i,c){return Wt(e,s,i,c),Wt(t,n,a,c),Wt(r,e,t,2*c*(1-c)),r}}(),function(){var e=Ee();return function(t,r,s,n){return e[0]=s[0],e[3]=s[1],e[6]=s[2],e[1]=n[0],e[4]=n[1],e[7]=n[2],e[2]=-r[0],e[5]=-r[1],e[8]=-r[2],Ht(t,ze(t,e))}}();const Lt=new Float64Array(16);function Kt(e,t,r){lt(Lt,r,-1),Zt(t,Lt)<Zt(t,r)?Vt(e,t,Lt):Vt(e,t,r)}const Bt=new Float64Array(16);function Ie(e,t){return Kt(Bt,e,t),Ue(Bt)}const X=Math.PI,tt=2*X,_e=X/2,gt=Math.PI/180,z=1/gt,et=new Float32Array(16),mt=new Float32Array(16),I=new Float32Array(4),rt=new Float32Array(3),jt=new Set,$e=[];let Y=!1;class te{constructor(){this.name="",this.quaternion=new Float32Array([0,0,0,1]),this.position=new Float32Array(3),this.matrix=new Float32Array(16),ft(this.matrix),this.matrixWorld=new Float32Array(16),ft(this.matrixWorld),this.matrixNeedsUpdate=!1,this.matrixWorldNeedsUpdate=!1,this.parent=null,this.children=[]}setPosition(...t){const r=this.position;Le(r,t)>1e-10&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],this.setMatrixNeedsUpdate())}setEuler(t,r,s){pt(I,t*z,r*z,s*z),this.setQuaternion(...I)}setQuaternion(...t){const r=this.quaternion;Ie(r,t)>1e-10&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],this.setMatrixNeedsUpdate())}setWorldPosition(t,r,s){const n=this.parent;rt[0]=t,rt[1]=r,rt[2]=s,n&&(n.updateMatrixWorld(),j(et,n.matrixWorld),We(rt,rt,et)),this.setPosition(...rt)}setWorldEuler(t,r,s){pt(I,t*z,r*z,s*z),this.setWorldQuaternion(...I)}setWorldQuaternion(t,r,s,n){const a=this;I[0]=t,I[1]=r,I[2]=s,I[3]=n,a&&(a.updateMatrixWorld(),j(et,a.matrixWorld),Ae(mt,I),N(mt,et,mt),G(I,mt)),this.setQuaternion(...I)}getWorldPosition(t){this.updateMatrixWorld(),Z(t,this.matrixWorld)}getWorldQuaternion(t){this.updateMatrixWorld(),G(t,this.matrixWorld)}traverseParents(t){let r;const s=Y;Y?r=new Set:(r=jt,r.clear()),Y=!0;let n=this.parent;for(;n&&!r.has(n);){if(t(n))return;r.add(n),n=n.parent}Y=s,r.clear()}traverse(t){const r=Y;let s,n;Y?(s=new Set,n=[this]):(s=jt,s.clear(),n=$e,n[0]=this),Y=!0;let a=0,i=1;for(;a<i;){const c=n[a];if(!t(c)){const l=c.children;for(let h=0,f=l.length;h<f;h++){const d=l[h];s.has(d)||(s.add(d),n[i]=d,i++)}}a++}Y=r,s.clear(),n.fill(null)}find(t){let r=null;return this.traverse(s=>{if(r)return!0;if(t(s))return r=s,!0}),r}addChild(t){if(t.parent)throw new Error("Frame: Added child must not already have a parent.");if(t===this)throw new Error("Frame: Frame cannot be added as a child to itself.");this.traverseParents(r=>{if(r===t)throw new Error("Frame: Added child is an ancestor of this Frame. Use Joint.makeClosure instead.")}),t.parent=this,this.children.push(t),t.setMatrixWorldNeedsUpdate()}removeChild(t){if(t.parent!==this)throw new Error("Frame: Child to be removed is not a child of this Frame.");const r=this.children.indexOf(t);this.children.splice(r,1),t.parent=null,t.setMatrixWorldNeedsUpdate()}attachChild(t){this.updateMatrixWorld(),t.updateMatrixWorld(),this.addChild(t),j(et,this.matrixWorld),N(t.matrix,et,t.matrixWorld),Z(t.position,t.matrix),G(t.quaternion,t.matrix)}detachChild(t){this.updateMatrixWorld(),t.updateMatrixWorld(),this.removeChild(t),Tt(t.matrix,t.matrixWorld),Z(t.position,t.matrix),G(t.quaternion,t.matrix)}computeMatrixWorld(){this.parent?N(this.matrixWorld,this.parent.matrixWorld,this.matrix):Tt(this.matrixWorld,this.matrix)}setMatrixNeedsUpdate(){this.matrixNeedsUpdate===!1&&(this.matrixNeedsUpdate=!0,this.setMatrixWorldNeedsUpdate())}setMatrixWorldNeedsUpdate(){this.traverse(t=>t.matrixWorldNeedsUpdate?!0:(t.matrixWorldNeedsUpdate=!0,!1))}updateMatrix(){this.matrixNeedsUpdate&&(Qt(this.matrix,this.quaternion,this.position),this.matrixNeedsUpdate=!1)}updateMatrixWorld(t=!1){const{parent:r}=this;this.matrixWorldNeedsUpdate&&(r&&r.matrixWorldNeedsUpdate&&r.updateMatrixWorld(!1),this.updateMatrix(),this.computeMatrixWorld(),this.matrixWorldNeedsUpdate=!1),t&&this.traverse(s=>{this!==s&&s.updateMatrixWorld(!1)})}}function Jt(e){let t=e%tt;return t>X?t-=tt:t<=-X&&(t+=tt),t}function O(e,t){const r=Math.round(e/tt)*tt,s=Jt(t);let n=r+s;const a=n-e;return Math.abs(a)>X&&(n-=Math.sign(a)*tt),n}function Rt(e,t,r){e[0]=O(t[0],r[0]),e[1]=O(t[1],r[1]),e[2]=O(t[2],r[2])}function Ft(e,t){return Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1])+Math.abs(e[2]-t[2])}function ee(e,t){e[0]=t[0]+X,e[1]=X-t[1],e[2]=t[2]+X}function re(e){const t=Jt(e[1]);return!(Math.abs(Math.abs(t)-_e)>1e-7)}function se(e,t,r){if(!re(r))return!1;const s=Jt(r[1]),n=-1*Math.sign(s),a=r[0]+n*r[2];return e[0]=t[0],e[1]=O(t[1],r[1]),e[2]=O(t[2],n*(a-t[0])),Rt(e,t,e),!0}const st=new Float64Array(3),b=new Float64Array(3);function kt(e,t,r){let s=1/0;if(re(r)){se(st,t,r),ee(b,r),se(b,t,b);const i=Ft(t,st),c=Ft(t,b);i<c?(ut(e,st),s=i):(ut(e,b),s=c)}Rt(st,t,r),ee(b,r),Rt(b,t,b);const n=Ft(t,st),a=Ft(t,b);(n<s||a<s)&&(n<a?ut(e,st):ut(e,b))}const ne=new Float64Array(3),oe=new Float64Array(4),ie=new Float64Array(3),ae=new Float64Array(4);function be(e,t){const[r,s,n,a]=t,i=2*(a*r+s*n),c=1-2*(r*r+s*s),o=Math.atan2(i,c);let l=2*(a*s-n*r);l=l>1?1:l,l=l<-1?-1:l;const h=Math.asin(l),f=2*(a*n+r*s),d=1-2*(s*s+n*n),u=Math.atan2(f,d);return e[0]=o*z,e[1]=h*z,e[2]=u*z,e}function Ut(e,t,r,s){Z(ne,e),G(oe,e),Z(ie,t),G(ae,t),Yt(r,ne,ie),Kt(s,oe,ae)}const y={X:0,Y:1,Z:2,EX:3,EY:4,EZ:5},Qe=Object.entries(y).sort((e,t)=>e[1]-t[1]).map(e=>e[0]),wt=new Float32Array(16),le=new Float32Array(16),he=new Float32Array(4),L=new Float32Array(3),ht=new Float32Array(3),H=new Float32Array(3),xt=new Float32Array(6);function ce(e,t){pt(he,t[y.EX]*z,t[y.EY]*z,t[y.EZ]*z),Qt(e,he,t)}class fe extends te{constructor(){super(),this.isJoint=!0,this.child=null,this.isClosure=!1,this.trackJointWrap=!1,this.rotationDoFCount=0,this.translationDoFCount=0,this.dof=[],this.dofFlags=new Uint8Array(6),this.dofValues=new Float32Array(6),this.dofTarget=new Float32Array(6),this.dofRestPose=new Float32Array(6),this.minDoFLimit=new Float32Array(6).fill(-1/0),this.maxDoFLimit=new Float32Array(6).fill(1/0),this.targetSet=!1,this.restPoseSet=!1,this.matrixDoFNeedsUpdate=!1,this.matrixDoF=new Float32Array(16),ft(this.matrixDoF),this.cachedIdentityDoFMatrixWorld=new Float32Array(16),ft(this.cachedIdentityDoFMatrixWorld)}_getQuaternion(t,r){pt(r,t[y.EX],t[y.EY],t[y.EZ])}_getEuler(t,r){r[0]=t[y.EX],r[1]=t[y.EY],r[2]=t[y.EZ]}_getPosition(t,r){r[0]=t[y.X],r[1]=t[y.Y],r[2]=t[y.Z]}_setValue(t,r,s){if(t===this.minDoFLimit||t==this.maxDoFLimit)throw new Error("Joint: Cannot set minDoFLimit or maxDoFLimit with _setValue.");if(r<0||r>6||typeof r!="number")throw new Error("Joint: Invalid DoF.");if(!this.dofFlags[r])return!1;const n=this.minDoFLimit[r],a=this.maxDoFLimit[r];return s<n&&(s=n),s>a&&(s=a),t[r]=s,s===a||s===n}_setValues(t,r){const s=this.dof;for(let n=0,a=r.length;n<a;n++)this._setValue(t,s[n],r[n])}_setViaFullPosition(t,r){const s=this.dofFlags;for(let n=0;n<3;n++)t[n]=s[n]*r[n]}_setViaFullEuler(t,r){const s=this.dofFlags;for(let n=3;n<6;n++)t[n]=s[n]*r[n-3];this.tryMinimizeEulerAngles()}_setViaQuaternion(t,r){if(be(H,r),H[0]*=gt,H[1]*=gt,H[2]*=gt,this.trackJointWrap){const s=this.dofValues;L[0]=s[y.EX],L[1]=s[y.EY],L[2]=s[y.EZ],kt(H,L,H)}this._setViaFullEuler(t,H)}clearDoF(){this.setDoF()}setDoF(...t){t.forEach((r,s)=>{if(r<0||r>=6)throw new Error("Joint: Invalid degree of freedom enum "+r+".");if(t.includes(r,s+1))throw new Error("Joint: Duplicate degree of freedom "+Qe[r]+"specified.");if(s!==0&&t[s-1]>r)throw new Error("Joint: Joints degrees of freedom must be specified in position then rotation, XYZ order")}),this.dof=t,this.dofValues.fill(0),this.dofTarget.fill(0),this.dofRestPose.fill(0),this.minDoFLimit.fill(-1/0),this.maxDoFLimit.fill(1/0),this.setMatrixDoFNeedsUpdate();for(let r=0;r<6;r++)this.dofFlags[r]=Number(t.includes(r));this.rotationDoFCount=this.dofFlags[y.EX]+this.dofFlags[y.EY]+this.dofFlags[y.EZ],this.translationDoFCount=this.dofFlags[y.X]+this.dofFlags[y.Y]+this.dofFlags[y.Z]}setDoFValues(...t){this.setMatrixDoFNeedsUpdate(),this._setValues(this.dofValues,t)}setDoFValue(t,r){return this.setMatrixDoFNeedsUpdate(),this._setValue(this.dofValues,t,r)}getDoFValue(t){return this.dofValues[t]}getDoFQuaternion(t){this._getQuaternion(this.dofValues,t)}getDoFEuler(t){this._getEuler(this.dofValues,t)}getDoFPosition(t){this._getPosition(this.dofValues,t)}setRestPoseValues(...t){this._setValues(this.dofRestPose,t)}setRestPoseValue(t,r){return this._setValue(this.dofRestPose,t,r)}getRestPoseValue(t){return this.dofRestPose[t]}getRestPoseQuaternion(t){this._getQuaternion(this.dofRestPose,t)}getRestPoseEuler(t){this._getEuler(this.dofRestPose,t)}getRestPosePosition(t){this._getPosition(this.dofRestPose,t)}setTargetValues(...t){this._setValues(this.dofTarget,t)}setTargetValue(t,r){this._setValue(this.dofTarget,t,r)}getTargetValue(t){return this.dofTarget[t]}getTargetQuaternion(t){this._getQuaternion(this.dofTarget,t)}getTargetEuler(t){this._getEuler(this.dofTarget,t)}getTargetPosition(t){this._getPosition(this.dofTarget,t)}setMinLimits(...t){const{dof:r}=this;for(const s in t){const n=r[s];this.setMinLimit(n,t[s])}}setMinLimit(t,r){this.minDoFLimit[t]=r,this.setDoFValue(t,this.dofValues[t])}getMinLimit(t){return this.minDoFLimit[t]}setMaxLimits(...t){const{dof:r}=this;for(const s in t){const n=r[s];this.setMaxLimit(n,t[s])}}setMaxLimit(t,r){this.maxDoFLimit[t]=r,this.setDoFValue(t,this.dofValues[t])}getMaxLimit(t){return this.maxDoFLimit[t]}getClosureError(t,r){if(!this.isClosure)throw new Error("Joint: Cannot get closure error on non closure Joint.");this.updateMatrixWorld(),this.child.updateMatrixWorld(),Ut(this.matrixWorld,this.child.matrixWorld,t,r)}tryMinimizeEulerAngles(){const{trackJointWrap:t,rotationDoFCount:r,dofRestPose:s,dofTarget:n,dofValues:a}=this;if(!t)if(r<3)for(let i=y.EX;i<=y.EZ;i++)n[i]=O(a[i],n[i]),s[i]=O(a[i],s[i]);else ht[0]=a[y.EX],ht[1]=a[y.EY],ht[2]=a[y.EZ],L[0]=n[y.EX],L[1]=n[y.EY],L[2]=n[y.EZ],kt(L,ht,L),n[y.EX]=L[0],n[y.EY]=L[1],n[y.EZ]=L[2],L[0]=s[y.EX],L[1]=s[y.EY],L[2]=s[y.EZ],kt(L,ht,L),s[y.EX]=L[0],s[y.EY]=L[1],s[y.EZ]=L[2]}getDeltaWorldMatrix(t,r,s){const{dofValues:n,minDoFLimit:a,maxDoFLimit:i,cachedIdentityDoFMatrixWorld:c}=this;this.updateMatrixWorld(),xt.set(n);const o=a[t],l=i[t],h=xt[t],f=h-o,d=l-h;let u=h+r;const m=r>0&&u>l,v=r<0&&u<o,p=m&&f>d||v&&d>f;return p&&(u=h-r),xt[t]=u,ce(le,xt),N(s,c,le),p}setMatrixDoFNeedsUpdate(){this.matrixDoFNeedsUpdate===!1&&(this.matrixDoFNeedsUpdate=!0,this.setMatrixWorldNeedsUpdate())}updateDoFMatrix(){this.matrixDoFNeedsUpdate&&(ce(this.matrixDoF,this.dofValues),this.matrixDoFNeedsUpdate=!1)}computeMatrixWorld(){const{parent:t,matrixWorld:r,matrix:s,matrixDoF:n,cachedIdentityDoFMatrixWorld:a}=this;this.updateDoFMatrix(),N(r,s,n),t?(N(r,t.matrixWorld,r),N(a,t.matrixWorld,s)):Tt(a,s)}makeClosure(t){if(!t.isLink||this.child||t.parent===this)throw new Error("Joint: Given child cannot be used to make closure.");this.child=t,this.isClosure=!0,t.closureJoints.push(this)}addChild(t){if(!t.isLink||this.child||t.parent===this)throw new Error("Joint: Given child cannot be added to Joint.");super.addChild(t),this.child=t,this.isClosure=!1}removeChild(t){if(this.isClosure){if(this.child!==t)throw new Error("Frame: Child to be removed is not a child of this Joint.");{this.child=null,this.isClosure=!1;const r=t.closureJoints.indexOf(this);t.closureJoints.splice(r,1)}}else super.removeChild(t)}attachChild(t){super.attachChild(t),j(wt,this.matrixDoF),N(t.matrix,wt,t.matrix),Z(t.position,t.matrix),G(t.quaternion,t.matrix)}detachChild(t){super.detachChild(t),j(wt,this.matrixDoF),N(t.matrix,wt,t.matrix),Z(t.position,t.matrix),G(t.quaternion,t.matrix)}}const J=new Float64Array(3),R=new Float64Array(4),K=new Float64Array(3);function de(e,t,r,s=null,n={isConverged:!1,rowCount:7,totalError:0}){const{translationConvergeThreshold:a,rotationConvergeThreshold:i,translationErrorClamp:c,rotationErrorClamp:o,translationFactor:l,rotationFactor:h}=e,{translationDoFCount:f,rotationDoFCount:d,dofFlags:u,dof:m}=t;t.getClosureError(J,R);let v=7;t.isGoal&&(J[0]*=u[0],J[1]*=u[1],J[2]*=u[2],v=f,d===0?(R[0]=0,R[1]=0,R[2]=0,R[3]=0):v+=4);let p=!1,w=0;const C=dt(J),D=ke(R);if(C<a&&D<i&&(p=!0),w+=C+D,s)if(C>c&&vt(J,J,c/C),lt(J,J,l),D>o&&lt(R,R,o/D),lt(R,R,h),t.isGoal){for(let F=0;F<f;F++){const x=m[F];s[r+F][0]=J[x]}t.rotationDoFCount===3&&(s[r+f+0][0]=R[0],s[r+f+1][0]=R[1],s[r+f+2][0]=R[2],s[r+f+3][0]=R[3])}else s[r+0][0]=J[0],s[r+1][0]=J[1],s[r+2][0]=J[2],s[r+3][0]=R[0],s[r+4][0]=R[1],s[r+5][0]=R[2],s[r+6][0]=R[3];return n.totalError=w,n.isConverged=p,n.rowCount=v,n}function ue(e,t,r,s=null,n={isConverged:!1,rowCount:7,totalError:0}){const{translationConvergeThreshold:a,rotationConvergeThreshold:i,lockedJointDoFCount:c,translationErrorClamp:o,rotationErrorClamp:l,lockedJointDoF:h}=e,{dofTarget:f,dofValues:d,translationDoFCount:u,rotationDoFCount:m,translationFactor:v,rotationFactor:p,dofList:w}=t,C=Se(d,f);let D=f[y.EX]-d[y.EX]+f[y.EY]-d[y.EY]+f[y.EZ]-d[y.EZ];const F=c.get(t)||0;if(n.rowCount=u+m-F,n.isConverged=C<a&&D<i,n.totalError=C+D,s){const x=h.get(t),g=F!==0;let E=0;J[0]=f[0]-d[0],J[1]=f[1]-d[1],J[2]=f[2]-d[2];const M=dt(J);vt(J,J,v*o/M);for(let P=0,W=u;P<W;P++){const A=w[P];g&&x[A]||(s[r+E][0]=J[A],E++)}K[0]=t.dofTarget[3]-t.dofValues[3],K[1]=t.dofTarget[4]-t.dofValues[4],K[2]=t.dofTarget[5]-t.dofValues[5];const S=dt(K);vt(K,K,p*l/S);for(let P=u,W=u+m;P<W;P++){const A=w[P];g&&x[A]||(s[r+E][0]=K[A],E++)}}}function Ge(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Dt={exports:{}},ve;function Xe(){return ve||(ve=1,function(e,t){var r=function(){function s(a,i){this.data=new Array(a.length);for(var c=0,o=a[0].length;c<a.length;c++){this.data[c]=new Array(o);for(var l=0;l<o;l++)this.data[c][l]=a[c][l]}if(i){if(typeof i[0]!="object")for(var c=0;c<i.length;c++)i[c]=[i[c]];this.mirror=new s(i)}}s.prototype.swap=function(a,i){this.mirror&&this.mirror.swap(a,i);var c=this.data[a];this.data[a]=this.data[i],this.data[i]=c},s.prototype.multline=function(a,i){this.mirror&&this.mirror.multline(a,i);for(var c=this.data[a],o=c.length-1;o>=0;o--)c[o]*=i},s.prototype.addmul=function(a,i,c){this.mirror&&this.mirror.addmul(a,i,c);for(var o=this.data[a],l=this.data[i],h=o.length-1;h>=0;h--)o[h]=o[h]+c*l[h]},s.prototype.hasNullLine=function(a){for(var i=0;i<this.data[a].length;i++)if(this.data[a][i]!==0)return!1;return!0},s.prototype.gauss=function(){for(var a=0,i=this.data.length,c=this.data[0].length,o=[],l=0;l<c;l++){for(var h=0,f=0,d=a;d<i;d++){var u=this.data[d][l];Math.abs(u)>Math.abs(h)&&(f=d,h=u)}if(h===0)o.push(a);else{this.multline(f,1/h),this.swap(f,a);for(var m=0;m<i;m++)m!==a&&this.addmul(m,a,-this.data[m][l])}a++}for(var m=0;m<o.length;m++)if(!this.mirror.hasNullLine(o[m]))throw new Error("singular matrix");return this.mirror.data},t.solve=function(i,c){var o=new s(i,c).gauss();if(o.length>0&&o[0].length===1)for(var l=0;l<o.length;l++)o[l]=o[l][0];return o};function n(a){for(var i=new Array(a),c=0;c<a;c++){i[c]=new Array(a);for(var o=0;o<a;o++)i[c][o]=c===o?1:0}return i}return t.invert=function(i){return new s(i,n(i.length)).gauss()},t}();e.exports=r}(Dt,Dt.exports)),Dt.exports}var Ye=Xe(),pe=Ge(Ye),Ze=function(t,r,s,n,a){if(r=r!==void 0?r:!0,s=s!==void 0?s:!0,n=n||Math.pow(2,-52),a=1e-64/n,!t)throw new TypeError("Matrix a is not defined");var i=t[0].length,c=t.length;if(c<i)throw new TypeError("Invalid matrix: m < n");var o,l,h,f,d,u,m,v,p,w,C,D,F;v=0,C=0;var x=[],g=[],E=[],M=r==="f"?c:i;for(o=0;o<c;o++)g[o]=new Array(M).fill(0);for(o=0;o<i;o++)E[o]=new Array(i).fill(0);var S=new Array(i).fill(0);for(o=0;o<c;o++)for(l=0;l<i;l++)g[o][l]=t[o][l];for(o=0;o<i;o++){for(x[o]=v,w=0,f=o+1,l=o;l<c;l++)w+=Math.pow(g[l][o],2);if(w<a)v=0;else for(m=g[o][o],v=m<0?Math.sqrt(w):-Math.sqrt(w),p=m*v-w,g[o][o]=m-v,l=f;l<i;l++){for(w=0,h=o;h<c;h++)w+=g[h][o]*g[h][l];for(m=w/p,h=o;h<c;h++)g[h][l]=g[h][l]+m*g[h][o]}for(S[o]=v,w=0,l=f;l<i;l++)w+=Math.pow(g[o][l],2);if(w<a)v=0;else{for(m=g[o][o+1],v=m<0?Math.sqrt(w):-Math.sqrt(w),p=m*v-w,g[o][o+1]=m-v,l=f;l<i;l++)x[l]=g[o][l]/p;for(l=f;l<c;l++){for(w=0,h=f;h<i;h++)w+=g[l][h]*g[o][h];for(h=f;h<i;h++)g[l][h]=g[l][h]+w*x[h]}}D=Math.abs(S[o])+Math.abs(x[o]),D>C&&(C=D)}if(s)for(o=i-1;o>=0;o--){if(v!==0){for(p=g[o][o+1]*v,l=f;l<i;l++)E[l][o]=g[o][l]/p;for(l=f;l<i;l++){for(w=0,h=f;h<i;h++)w+=g[o][h]*E[h][l];for(h=f;h<i;h++)E[h][l]=E[h][l]+w*E[h][o]}}for(l=f;l<i;l++)E[o][l]=0,E[l][o]=0;E[o][o]=1,v=x[o],f=o}if(r){if(r==="f")for(o=i;o<c;o++){for(l=i;l<c;l++)g[o][l]=0;g[o][o]=1}for(o=i-1;o>=0;o--){for(f=o+1,v=S[o],l=f;l<M;l++)g[o][l]=0;if(v!==0){for(p=g[o][o]*v,l=f;l<M;l++){for(w=0,h=f;h<c;h++)w+=g[h][o]*g[h][l];for(m=w/p,h=o;h<c;h++)g[h][l]=g[h][l]+m*g[h][o]}for(l=o;l<c;l++)g[l][o]=g[l][o]/v}else for(l=o;l<c;l++)g[l][o]=0;g[o][o]=g[o][o]+1}}n=n*C;var P;for(h=i-1;h>=0;h--)for(var W=0;W<50;W++){for(P=!1,f=h;f>=0;f--){if(Math.abs(x[f])<=n){P=!0;break}if(Math.abs(S[f-1])<=n)break}if(!P){for(u=0,w=1,d=f-1,o=f;o<h+1&&(m=w*x[o],x[o]=u*x[o],!(Math.abs(m)<=n));o++)if(v=S[o],S[o]=Math.sqrt(m*m+v*v),p=S[o],u=v/p,w=-m/p,r)for(l=0;l<c;l++)D=g[l][d],F=g[l][o],g[l][d]=D*u+F*w,g[l][o]=-D*w+F*u}if(F=S[h],f===h){if(F<0&&(S[h]=-F,s))for(l=0;l<i;l++)E[l][h]=-E[l][h];break}for(C=S[f],D=S[h-1],v=x[h-1],p=x[h],m=((D-F)*(D+F)+(v-p)*(v+p))/(2*p*D),v=Math.sqrt(m*m+1),m=((C-F)*(C+F)+p*(D/(m<0?m-v:m+v)-p))/C,u=1,w=1,o=f+1;o<h+1;o++){if(v=x[o],D=S[o],p=w*v,v=u*v,F=Math.sqrt(m*m+p*p),x[o-1]=F,u=m/F,w=p/F,m=C*u+v*w,v=-C*w+v*u,p=D*w,D=D*u,s)for(l=0;l<i;l++)C=E[l][o-1],F=E[l][o],E[l][o-1]=C*u+F*w,E[l][o]=-C*w+F*u;if(F=Math.sqrt(m*m+p*p),S[o-1]=F,u=m/F,w=p/F,m=u*v+w*D,C=-w*v+u*D,r)for(l=0;l<c;l++)D=g[l][o-1],F=g[l][o],g[l][o-1]=D*u+F*w,g[l][o]=-D*w+F*u}x[f]=0,x[h]=m,S[h]=C}for(o=0;o<i;o++)S[o]<n&&(S[o]=0);return{u:g,q:S,v:E}};function Oe(e,t){const r=t.length,s=t[0].length;for(let n=0;n<r;n++)for(let a=0;a<s;a++)e[a][n]=t[n][a]}function He(e){for(let t=0,r=e.length;t<r;t++)for(let s=0,n=e.length;s<n;s++)e[t][s]=t===s?1:0}function Ke(e,t,r){for(let s=0,n=e.length;s<n;s++)for(let a=0,i=e.length;a<i;a++)e[s][a]=t[s][a]*r}function Be(e,t,r){if(t===e||r===e)throw new Error("Matrix: Cannot multiply to a matrix in place.");const s=t.length,n=r.length,a=r[0].length;for(let i=0,c=s;i<c;i++)for(let o=0,l=a;o<l;o++){let h=0;for(let f=0,d=n;f<d;f++)h+=t[i][f]*r[f][o];e[i][o]=h}}function ge(e,t){const r=new Array(e);for(let s=0;s<e;s++)r[s]=new Float64Array(t);return r}function me(e,t){const r=t.length,s=t[0].length;for(let n=0;n<r;n++)for(let a=0;a<s;a++)e[n][a]=t[n][a]}function je(e){const t=e.length,r=e[0].length,s=ge(t,r);return me(s,e),s}function tr(e,t,r){const s=pe.solve(t,r);for(let n=0,a=s.length;n<a;n++)e[n].set(s[n])}function er(e,t,r,s){const{u:n,v:a,q:i}=Ze(s),c=n.length;for(let h=0;h<c;h++)e[h].set(n[h]);const o=a.length;for(let h=0;h<o;h++)r[h].set(a[h]);const l=i.length;for(let h=0;h<l;h++){const f=t[h],d=i[h];f.fill(0),f[h]=d}}function rr(e,t){const r=pe.invert(t),s=t[0].length,n=t.length;for(let a=0;a<s;a++)for(let i=0;i<n;i++)e[a][i]=r[a][i]}function sr(e,t,r){const s=t.length,n=t[0].length;for(let a=0;a<s;a++)for(let i=0;i<n;i++)e[a][i]=t[a][i]+r[a][i]}function nr(e,t,r){const s=t.length,n=t[0].length;for(let a=0;a<s;a++)for(let i=0;i<n;i++)e[a][i]=t[a][i]-r[a][i]}function Fe(e){let t=0;const r=e.length,s=e[0].length;for(let n=0;n<r;n++)for(let a=0;a<s;a++)t+=e[n][a]**2;return t}function or(e){return Math.sqrt(Fe(e))}function we(e,t=3){const r=e.length,s=e[0].length;let n="";for(let a=0;a<r;a++){for(let i=0;i<s;i++)n+=e[a][i].toFixed(t)+", ";n+=`
`}return n}function ir(e,t){console.log(we(e,t))}const k={transpose:Oe,identity:He,scale:Ke,multiply:Be,create:ge,copy:me,clone:je,solve:tr,svd:er,invert:rr,add:sr,subtract:nr,magnitudeSquared:Fe,magnitude:or,toString:we,log:ir},yt=new Float64Array(16),Ct=new Float64Array(16),Nt=new Float64Array(16),qt=new Float64Array(16),q=new Float64Array(4),Q=new Float64Array(3),zt=new Float64Array(4),It=new Float64Array(3),ct=[],B=[],U={rowCount:0,isConverged:!1,totalError:0},xe={errorRows:0,freeDoF:0,totalError:0},nt={CONVERGED:0,STALLED:1,DIVERGED:2,TIMEOUT:3};Object.entries(nt).sort((e,t)=>e[1]-t[1]).map(e=>e[0]);class ar{constructor(t){this.chain=Array.from(t),this.targets=null,this.affectedClosures=null,this.affectedConnectedClosures=null,this.lockedJointDoFCount=null,this.lockedJointDoF=null,this.prevDoFValues=null,this.maxIterations=-1,this.matrixPool=null,this.useSVD=!1,this.translationConvergeThreshold=-1,this.rotationConvergeThreshold=-1,this.translationFactor=-1,this.rotationFactor=-1,this.translationStep=-1,this.rotationStep=-1,this.translationErrorClamp=-1,this.rotationErrorClamp=-1,this.stallThreshold=-1,this.dampingFactor=-1,this.divergeThreshold=-1,this.restPoseFactor=-1,this.init()}init(){const t=this.chain,r=t.filter(o=>o.targetSet||o.isClosure),s=new Map,n=new Map,a=new Map,i=new Map,c=new Map;t.forEach(o=>{i.set(o,new Set),c.set(o,new Set),s.set(o,new Uint8Array(6)),a.set(o,new Float64Array(6))}),r.forEach(o=>{if(o.isClosure){let l=o;for(;l;)l.isJoint&&i.get(l).add(o),l=l.parent;for(l=o.child;l;)l.isJoint&&c.get(l).add(o),l=l.parent}}),this.targets=r,this.affectedClosures=i,this.affectedConnectedClosures=c,this.lockedJointDoF=s,this.lockedJointDoFCount=n,this.prevDoFValues=a}solve(){const{divergeThreshold:t,stallThreshold:r,chain:s,restPoseFactor:n,lockedJointDoFCount:a,prevDoFValues:i,useSVD:c,matrixPool:o}=this;let l=0,h=1/0,f=-1;a.clear();for(let d=0,u=s.length;d<u;d++){const m=s[d];(m.targetSet||m.restPoseSet)&&m.tryMinimizeEulerAngles()}do{o.releaseAll();for(let F=0,x=s.length;F<x;F++)s[F].updateMatrixWorld();ct.length=0,B.length=0,this.countUnconvergedVariables(B,ct,xe);const{freeDoF:d,errorRows:u,totalError:m}=xe;if(u===0){f=nt.CONVERGED;break}if(m>h+t){i.forEach((F,x)=>{x.dofValues.set(F),x.setMatrixDoFNeedsUpdate()}),f=nt.DIVERGED;break}if(h=m,l++,l>this.maxIterations){f=nt.TIMEOUT;break}const v=o.get(u,1);this.fillErrorVector(ct,v);const p=o.get(u,d);this.fillJacobian(ct,B,p);const w=o.get(d,u);let C=!1;if(c)try{const F=u,x=d,g=Math.min(F,x),E=o.get(F,g),M=o.get(g,g),S=o.get(x,g);k.svd(E,M,S,p);const P=o.get(g,F),W=o.get(g,g);k.transpose(P,E);for(let V=0,T=M.length;V<T;V++){const it=M[V][V];let _;Math.abs(it)<.001?_=0:_=1/it,W[V][V]=_}const A=o.get(x,g);k.multiply(A,S,W),k.multiply(w,A,P)}catch{C=!0}if(!c||C){const F=o.get(u,u);k.identity(F),k.scale(F,F,this.dampingFactor**2);const x=o.get(d,u);k.transpose(x,p);const g=o.get(u,u);k.multiply(g,p,x);const E=o.get(u,u);k.add(E,g,F);const M=o.get(u,u);k.invert(M,E),k.multiply(w,x,M)}const D=o.get(d,1);if(k.multiply(D,w,v),n!==0){const F=o.get(d,1),x=o.get(d,1);let g=0;for(let P=0,W=B.length;P<W;P++){const A=B[P],V=this.lockedJointDoFCount.get(A)||0,T=V!==0,it=this.lockedJointDoF.get(A),_=A.rotationDoFCount+A.translationDoFCount-V;if(A.restPoseSet){const at=A.dof,xr=A.dofValues,Dr=A.dofRestPose;for(let $t=0;$t<_;$t++){const bt=at[$t];T&&it[bt]||(F[g][0]=Dr[bt]-xr[bt],g++)}}else for(let at=0;at<_;at++)F[g][0]=0,g++}const E=o.get(d,d);k.multiply(E,w,p);const M=o.get(d,d);k.identity(M);const S=o.get(d,d);k.subtract(S,M,E),k.multiply(x,S,F);for(let P=0;P<d;P++){const W=x[P][0];D[P][0]+=W*n}}if(r>0){let F=!0;for(let x=0,g=D.length;x<g;x++){const E=D[x][0];if(Math.abs(E)>r){F=!1;break}}if(F){f=nt.STALLED;break}}i.forEach((F,x)=>{F.set(x.dofValues)}),this.applyJointAngles(B,D)}while(!0);return ct.length=0,B.length=0,f}applyJointAngles(t,r){const{lockedJointDoF:s,lockedJointDoFCount:n}=this;let a=!1,i=0;for(let c=0,o=t.length;c<o;c++){const l=t[c],h=l.dof,f=s.get(l),d=n.has(l);for(let u=0,m=h.length;u<m;u++){const v=h[u];if(d&&f[v])continue;const p=l.getDoFValue(v);if(l.setDoFValue(v,p+r[i][0])){n.has(l)||(n.set(l,0),f.fill(0));const C=n.get(l);n.set(l,C+1),f[v]=1,a=!0}i++}}if(i!==r.length)throw new Error;return a}fillJacobian(t,r,s){const{translationStep:n,rotationStep:a,lockedJointDoF:i,lockedJointDoFCount:c,translationFactor:o,rotationFactor:l}=this,h=this.affectedClosures,f=this.affectedConnectedClosures;let d=0;for(let u=0,m=r.length;u<m;u++){const v=r[u],p=h.get(v),w=f.get(v),C=v.dof,D=v.translationDoFCount+v.rotationDoFCount,F=c.has(v),x=i.get(v);j(qt,v.matrixWorld);for(let g=0;g<D;g++){const E=C[g];if(F&&x[E])continue;let M=0,S=E<3?n:a;v.getDeltaWorldMatrix(E,S,Nt)&&(S*=-1);for(let P=0,W=t.length;P<W;P++){const A=t[P];if(A.isClosure)if(p.has(A)||w.has(A))if(A.getClosureError(Q,q),w.has(A)?(N(yt,qt,A.child.matrixWorld),N(Ct,Nt,yt),Ut(A.matrixWorld,Ct,It,zt)):(N(yt,qt,A.matrixWorld),N(Ct,Nt,yt),Ut(Ct,A.child.matrixWorld,It,zt)),Yt(Q,Q,It),vt(Q,Q,o/S),Vt(q,q,zt),lt(q,q,l/S),A.isGoal){const{translationDoFCount:V,rotationDoFCount:T,dof:it}=A;for(let _=0;_<V;_++){const at=it[_];s[M+_][d]=Q[at]}T===3&&(s[M+V+0][d]=q[0],s[M+V+1][d]=q[1],s[M+V+2][d]=q[2],s[M+V+3][d]=q[3],M+=4),M+=V}else s[M+0][d]=Q[0],s[M+1][d]=Q[1],s[M+2][d]=Q[2],s[M+3][d]=q[0],s[M+4][d]=q[1],s[M+5][d]=q[2],s[M+6][d]=q[3],M+=7;else{let V=7;A.isGoal&&(V=A.translationDoFCount,A.rotationDoFCount===3&&(V+=4));for(let T=0;T<V;T++)s[M+T][d]=0;M+=V}if(A.targetSet){const V=A.translationDoFCount+A.rotationDoFCount;if(v===A)for(let T=0;T<V;T++)s[M+d][d]=-1;else for(let T=0;T<V;T++)s[M+T][d]=0;M+=V}}d++}}if(d!==s[0].length)throw new Error}fillErrorVector(t,r){let s=0;for(let n=0,a=t.length;n<a;n++){const i=t[n];i.isClosure&&(de(this,i,s,r,U),s+=U.rowCount),i.targetSet&&(ue(this,i,s,r,U),s+=U.rowCount)}}countUnconvergedVariables(t,r,s){const{lockedJointDoFCount:n}=this,a=this.chain;let i=0,c=0,o=0,l=0;for(let h=0,f=a.length;h<f;h++){let d=!1;const u=a[h],m=n.get(u)||0;u.isClosure&&(de(this,u,c,null,U),U.isConverged||(o+=U.rowCount,i+=U.totalError),d=!0,c+=U.rowCount);const v=u.dof;u.targetSet&&(ue(this,u,c,null,U),U.isConverged||(o+=U.rowCount,i+=U.totalError),d=!0,c+=U.rowCount),!u.isGoal&&v.length>0&&(l+=v.length-m,t.push(u)),d&&r.push(u)}o===0&&(c=0),s.errorRows=c,s.freeDoF=l,s.totalError=i}}function lr(e){const t=e.map(n=>{let a=n;return n.traverseParents(i=>{a=i}),a}),r=[],s=new Set;for(let n=0;n<t.length;n++){const a=t[n];s.has(a)||(r.push(a),a.traverse(i=>{if(s.has(i))return!0;s.add(i);let c;i.isLink?c=i.closureJoints:i.isJoint&&i.isClosure&&(c=[i.child]),c&&c.forEach(o=>{let l=o;o.traverseParents(h=>{l=h}),s.has(l)||t.push(l)})}))}return r}class hr{constructor(t,r){const s=[];let n=0;this.get=function(){let a=s[n];return a||(s[n]=a=k.create(t,r)),n++,a},this.releaseAll=function(){n=0}}}class cr{constructor(){const t={},r=[];this.get=function(s,n){let a=t[s];a||(a=t[s]={});let i=a[n];return i||(i=a[n]=new hr(s,n),r.push(i)),i.get()},this.releaseAll=function(){for(let s=0,n=r.length;s<n;s++)r[s].releaseAll()}}}class fr{constructor(t=[]){this.matrixPool=new cr,this.useSVD=!1,this.maxIterations=5,this.stallThreshold=1e-4,this.dampingFactor=.001,this.divergeThreshold=.01,this.restPoseFactor=.01,this.translationConvergeThreshold=.001,this.rotationConvergeThreshold=1e-5,this.translationFactor=1,this.rotationFactor=1,this.translationStep=.001,this.rotationStep=.001,this.translationErrorClamp=.1,this.rotationErrorClamp=.1,this.roots=Array.isArray(t)?[...t]:[t],this.solvers=null,this.updateStructure()}updateStructure(){const t=lr(this.roots),r=[],s=new Set,n=new Set,a=o=>{if(o.isJoint){const h=o;if(s.add(h),h.isClosure){const f=new Set;let d=h.child;for(;d;){if(d.isJoint){if(s.has(d))break;f.add(d),n.add(d)}d=d.parent}s.forEach(u=>{f.add(u),n.add(u)}),r.push(f)}}const l=o.children;for(let h=0,f=l.length;h<f;h++)a(l[h]);s.delete(o)};t.forEach(a);const i=[];for(;r.length;){const o=r.pop();i.push(o);for(let l=0;l<r.length;l++){const h=r[l];let f=!1;h.forEach(d=>{f=f||o.has(d)}),f&&(h.forEach(d=>o.add(d)),r.splice(l,1),l--)}}const c=new Set;t.forEach(o=>o.traverse(l=>{l.isJoint&&l.dof.length>0&&!n.has(l)&&c.add(l)})),this.solvers=i.map(o=>new ar(o)),this.nonChainJoints=c}solve(){const{solvers:t,nonChainJoints:r}=this;r.forEach(n=>{n.targetSet&&(n.dofValues.set(n.dofTarget),n.setMatrixDoFNeedsUpdate())});const s=[];for(let n=0,a=t.length;n<a;n++){const i=t[n];i.matrixPool=this.matrixPool,i.useSVD=this.useSVD,i.maxIterations=this.maxIterations,i.stallThreshold=this.stallThreshold,i.dampingFactor=this.dampingFactor,i.divergeThreshold=this.divergeThreshold,i.restPoseFactor=this.restPoseFactor,i.translationConvergeThreshold=this.translationConvergeThreshold,i.rotationConvergeThreshold=this.rotationConvergeThreshold,i.translationFactor=this.translationFactor,i.rotationFactor=this.rotationFactor,i.translationStep=this.translationStep,i.rotationStep=this.rotationStep,i.translationErrorClamp=this.translationErrorClamp,i.rotationErrorClamp=this.rotationErrorClamp;const c=i.solve();s.push(c)}return s}}class dr extends te{constructor(){super(),this.isLink=!0,this.closureJoints=[]}addChild(t){if(t.isJoint)super.addChild(t);else throw new Error("Link: Added child must be a Joint.")}}class ur extends fe{constructor(...t){super(...t),this.isGoal=!0,this.setFreeDoF()}setDoF(...t){let r=Number(t.includes(y.EX))+Number(t.includes(y.EY))+Number(t.includes(y.EZ));if(r!==0&&r!==3)throw new Error("Goal: Only full 3 DoF or 0 DoF rotation goals are supported.");super.setDoF(...t)}setGoalDoF(...t){this.setDoF(...t)}setFreeDoF(...t){const r=[y.X,y.Y,y.Z,y.EX,y.EY,y.EZ].filter(s=>!t.includes(s));this.setDoF(...r)}addChild(){throw new Error("Goal: Cannot add children to Goal.")}}function vr(e){const t=e.map(r=>{const{type:s,name:n,position:a,quaternion:i,dof:c,dofValues:o,dofTarget:l,dofRestPose:h,minDoFLimit:f,maxDoFLimit:d,targetSet:u,restPoseSet:m,isClosure:v}=r;let p;switch(s){case"Goal":case"Joint":p=s==="Goal"?new ur:new fe,p.setDoF(...c),p.dofValues.set(o),p.dofTarget.set(l),p.dofRestPose.set(h),p.minDoFLimit.set(f),p.maxDoFLimit.set(d),p.targetSet=u,p.restPoseSet=m,p.isClosure=v;break;case"Link":p=new dr;break}return p.name=n,p.position.set(a),p.quaternion.set(i),p});for(let r=0;r<t.length;r++){const s=t[r],n=e[r];s.parent=t[n.parent]||null,s.children.push(...n.children.map(a=>t[a])),s.setMatrixNeedsUpdate(),s.isLink&&s.closureJoints.push(...n.closureJoints.map(a=>t[a])),s.isJoint&&(s.child=n.child!==null?t[n.child]:null,s.setMatrixDoFNeedsUpdate())}return t}const De=304;function pr(e,t,r,s=!0,n=!0){for(let a=0,i=e.length;a<i;a++)mr(e[a],t,r,a*De,s,n)}function gr(e,t,r,s=!0,n=!0){for(let a=0,i=e.length;a<i;a++)Fr(e[a],t,r,De*a,s,n)}function mr(e,t,r,s,n=!0,a=!0){const i=s/4;if(a){const{position:c,quaternion:o}=e;for(let l=0;l<3;l++)t[i+0+l]=c[l];for(let l=0;l<4;l++)t[i+3+l]=o[l];if(e.isJoint){const{dofTarget:l,dofRestPose:h,minDoFLimit:f,maxDoFLimit:d,targetSet:u,restPoseSet:m}=e;for(let v=0;v<6;v++)t[i+7+0*6+v]=l[v],t[i+7+1*6+v]=h[v],t[i+7+2*6+v]=f[v],t[i+7+3*6+v]=d[v];r[s+148]=Number(u),r[s+149]=Number(m)}}if(n&&e.isJoint){const{dofValues:c}=e;for(let o=0;o<6;o++)t[i+7+4*6+o]=c[o]}}function Fr(e,t,r,s,n=!0,a=!0){const i=s/4;if(a&&(e.setPosition(t[i+0],t[i+1],t[i+2]),e.setQuaternion(t[i+3+0],t[i+3+1],t[i+3+2],t[i+3+3]),e.isJoint)){const{dofTarget:c,dofRestPose:o,minDoFLimit:l,maxDoFLimit:h}=e;for(let f=0;f<6;f++)c[f]=t[i+7+0*6+f],o[f]=t[i+7+1*6+f],l[f]=t[i+7+2*6+f],h[f]=t[i+7+3*6+f];e.targetSet=!!r[s+148],e.restPoseSet=!!r[s+149]}if(n&&e.isJoint){const{dofValues:c}=e;let o=!1;for(let l=0;l<6;l++){const h=t[i+7+24+l];h!==c[l]&&(c[l]=h,o=!0)}o&&e.setMatrixDoFNeedsUpdate()}}const wr=typeof SharedArrayBuffer<"u";let Et=new fr,ot=-1,Mt=null,At=null,_t=null,St=null;self.onmessage=function({data:e}){const{type:t,data:r}=e;switch(t){case"updateStructure":Mt=vr(r.serialized),Et.roots=Mt.filter(s=>s.parent===null),Et.updateStructure(),At=r.buffer,St=new Uint8Array(At),_t=new Float32Array(At);break;case"updateFrameState":St.set(new Uint8Array(r.buffer));break;case"updateSolverSettings":Object.assign(Et,r);break;case"startSolve":ot===-1&&ye();break;case"endSolve":ot!==-1&&(clearTimeout(ot),ot=-1);break}};function ye(){gr(Mt,_t,St,!1,!0);const e=Et.solve();if(pr(Mt,_t,St,!0,!1),e.find(t=>t===nt.TIMEOUT)?ot=setTimeout(ye):ot=-1,wr)self.postMessage({type:"updateSolve",data:{status:e}});else{const t=At.slice();self.postMessage({type:"updateSolve",data:{status:e,buffer:t}},[t])}}})();
