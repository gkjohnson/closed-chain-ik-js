import{f as Z,B as ie,h as re,V as le,W as de,d as ce,P as ue,S as pe,C as ee,D as he,A as me,G as te,M as B,i as Q,j as X,I as Y,k as we,l as fe,t as ge,J as K,m as be,L as ve,c as xe,g as ye,b as oe,R as Se}from"./IKRootsHelper-DmBdh0X7.js";import{S as ke,O as Ce,T as Te}from"./stats.module-BFsq5STz.js";import{l as z,W as F,a as N,b as _,c as $}from"./loadModels-ByAYFaEt.js";import{a as Ee}from"./URDFLoader-Dz40SxeK.js";const h={solve:!0,displayMesh:!0,displayIk:!0,displayGoals:!0,displayShadows:!0,model:"ATHLETE",webworker:!0},S={useSVD:!1,maxIterations:3,divergeThreshold:.05,stallThreshold:1e-4,translationErrorClamp:.25,rotationErrorClamp:.25,translationConvergeThreshold:.001,rotationConvergeThreshold:1e-5,restPoseFactor:.025},L=new Map,T=new Map,g=[],E=[];let d=-1,W=0,H=0,j=0,b,D,A,v,f,C,x,i,p,w,q,k,P,m,l,R=new Z;const Me=new ie,M=new re,O=new le;Le();ae();J(z());ne();function Le(){D=new ke,document.body.appendChild(D.dom),A=document.getElementById("output"),v=new de({antialias:!0}),v.setPixelRatio(window.devicePixelRatio),v.setSize(window.innerWidth,window.innerHeight),v.shadowMap.enabled=!0,v.shadowMap.type=ce,document.body.appendChild(v.domElement),C=new ue(50,window.innerWidth/window.innerHeight),C.position.set(8,8,8),f=new pe,f.background=new ee(1250841),x=new he(16777215,3),x.position.set(1,3,2),x.castShadow=!0,x.shadow.mapSize.setScalar(2048),f.add(x,x.target);const o=new me(2503224,3);f.add(o),P=new Ce(C,v.domElement),m=new Te(C,v.domElement),m.setSpace("local"),f.add(m.getHelper()),m.addEventListener("mouseDown",()=>P.enabled=!1),m.addEventListener("mouseUp",()=>P.enabled=!0),l=new te,l.position.set(0,1,1),f.add(l),m.attach(l),window.addEventListener("resize",()=>{const e=window.innerWidth,t=window.innerHeight,n=e/t;v.setSize(e,t),C.aspect=n,C.updateProjectionMatrix()}),window.addEventListener("keydown",e=>{switch(e.key){case"w":m.setMode("translate");break;case"e":m.setMode("rotate");break;case"q":m.setSpace(m.space==="local"?"world":"local");break;case"f":P.target.set(0,0,0),P.update();break}}),m.addEventListener("mouseUp",()=>{if(d!==-1){const e=g[d],t=L.get(e);t&&(t.updateMatrixWorld(),t.attachChild(e),e.setPosition(...e.originalPosition),e.setQuaternion(...e.originalQuaternion),t.detachChild(e),l.position.set(...e.position),l.quaternion.set(...e.quaternion))}}),v.domElement.addEventListener("pointerdown",e=>{R.x=e.clientX,R.y=e.clientY}),v.domElement.addEventListener("pointerup",e=>{if(Math.abs(e.clientX-R.x)>3||Math.abs(e.clientY-R.y)>3||!k)return;const{ikLink:t,result:n}=qe(e);if(t===null&&(d=-1),e.button===2){if(!t)return;if(T.has(t)){const se=T.get(t);a(se)}const s=new we;s.copy(n.face.normal),s.w=0,s.applyMatrix4(n.object.matrixWorld);const r=fe(),c=[0,0,0],y=s.toArray();let G=[0,1,0];Math.abs(y[1])>.9&&(G=[0,0,1]),ge(r,c,y,G);const u=new K;u.name="GoalRootJoint-"+t.name,u.setPosition(n.point.x,n.point.y,n.point.z),be(u.quaternion,r);const U=new ve;u.addChild(U);const I=new K;u.name="GoalJoint-"+t.name,t.getWorldPosition(I.position),t.getWorldQuaternion(I.quaternion),I.setMatrixNeedsUpdate(),U.attachChild(I),I.makeClosure(t),t.attachChild(u),u.originalPosition=u.position.slice(),u.originalQuaternion=u.quaternion.slice(),t.detachChild(u),i.updateStructure(),p.updateStructure(),w.updateStructure(),l.position.set(...u.position),l.quaternion.set(...u.quaternion),L.set(u,t),T.set(t,u),g.push(u),d=g.length-1}else if(e.button===0&&!m.dragging){if(d=E.indexOf(n?n.object.parent:null),d!==-1){const s=g[d];l.position.set(...s.position),l.quaternion.set(...s.quaternion)}else if(t&&T.has(t)){const s=T.get(t);d=g.indexOf(s),l.position.set(...s.position),l.quaternion.set(...s.quaternion)}}}),window.addEventListener("keydown",e=>{d!==-1&&(e.code==="Delete"||e.code==="Backspace")&&(a(g[d]),d=-1)});function a(e){const t=g.indexOf(e),n=g[t];n.traverse(r=>{r.isClosure&&r.removeChild(r.child)}),g.splice(t,1);const s=L.get(n);L.delete(n),T.delete(s),i.updateStructure(),p.updateStructure(),w.updateStructure()}}function qe(o){const a=new Se,e=new Z;e.x=o.clientX/window.innerWidth*2-1,e.y=-(o.clientY/window.innerHeight)*2+1,a.setFromCamera(e,C);let t;const n=[...E];if(n.length=g.length,t=a.intersectObjects(n,!0),t.length!==0)return{ikLink:null,result:t[0]};if(t=a.intersectObjects([k],!0),t.length===0)return{ikLink:null,result:null};const s=t[0];let r=null,c=null;return s.object.traverseAncestors(y=>{r===null&&y.isURDFLink&&(r=y,q.traverse(G=>{G.name===r.name&&(c=G)}))}),{ikLink:c,result:s}}function ne(){requestAnimationFrame(ne);const o=g,a=o[d];if(q){if(a&&(a.setPosition(l.position.x,l.position.y,l.position.z),a.setQuaternion(l.quaternion.x,l.quaternion.y,l.quaternion.z,l.quaternion.w)),h.solve){const e=window.performance.now();let t;i instanceof F?(i.updateFrameState(...o),i.updateSolverSettings(S),t=i.status,i.running||i.solve()):(Object.assign(i,S),t=i.solve());const s=window.performance.now()-e;A.innerText=`solve time 	: ${s.toFixed(3)}ms
`,j<50&&j++,H+=(s-H)/j,A.innerText+=`avg solve time 	: ${H.toFixed(3)}ms
`,A.innerText+=t.map(r=>xe[r]).join(`
`),Ee(k,q)}k.visible=h.displayMesh,!h.displayIk&&p.parent?(f.remove(p),f.remove(w)):h.displayIk&&!p.parent&&(f.add(p),f.add(w))}for(;E.length<o.length;){let c=function(...y){this.scale.setScalar(this.position.distanceTo(C.position)*.15),r.call(this,...y)};const e=new ee(16763432),t=new te,n=new B(new Q(.05,30,30),new X({color:e})),s=new B(new Q(.05,30,30),new X({color:e,opacity:.4,transparent:!0,depthWrite:!1,depthTest:!1})),r=n.updateMatrix;n.updateMatrix=c,s.updateMatrix=c,t.add(n,s),f.add(t),E.push(t)}if(E.forEach(e=>e.visible=!1),o.forEach((e,t)=>{E[t].position.set(...e.position),E[t].quaternion.set(...e.quaternion),E[t].visible=h.displayGoals}),m.enabled=d!==-1,m.visible=d!==-1,k!==null){Me.setFromObject(k).getBoundingSphere(M),O.subVectors(x.position,x.target.position),x.target.position.copy(M.center);const e=x.shadow.camera;e.left=e.bottom=-M.radius,e.right=e.top=M.radius,e.near=0,e.far=M.radius*2,e.updateProjectionMatrix(),O.normalize().multiplyScalar(M.radius),x.position.addVectors(M.center,O)}x.castShadow=h.displayShadows,v.render(f,C),D.update()}function ae(){if(b&&b.destroy(),!q)return;b=new ye,b.width=350,b.add(h,"model",["ATHLETE","Robonaut","Curiosity","Staubli"]).onChange(a=>{let e=null;switch(a){case"ATHLETE":e=z();break;case"Robonaut":e=$();break;case"Curiosity":e=_();break;case"Staubli":e=N();break}J(e)}),b.add(h,"displayMesh").name("display mesh"),b.add(h,"displayGoals").name("display goals"),b.add(h,"displayIk").name("display ik chains"),b.add(h,"displayShadows").name("shadows"),b.add(h,"webworker").onChange(a=>{a?i=new F(i.roots):(i.dispose(),i=new oe(i.roots))}),b.add({reset:()=>{let a=null;switch(h.model){case"ATHLETE":a=z();break;case"Robonaut":a=$();break;case"Curiosity":a=_();break;case"Staubli":a=N();break}J(a)}},"reset");const o=b.addFolder("solver");o.add(h,"solve").onChange(a=>{!a&&i instanceof F&&i.stop()}),o.add(S,"useSVD"),o.add(S,"maxIterations").min(1).max(10).step(1).listen(),o.add(S,"divergeThreshold").min(0).max(.5).step(.01).listen(),o.add(S,"stallThreshold").min(0).max(.01).step(1e-4).listen(),o.add(S,"translationErrorClamp").min(.01).max(1).listen(),o.add(S,"rotationErrorClamp").min(.01).max(1).listen(),o.add(S,"translationConvergeThreshold").min(.001).max(.1).listen(),o.add(S,"rotationConvergeThreshold").min(1e-5).max(.01).listen(),o.add(S,"restPoseFactor").min(0).max(.25).step(.01).listen(),o.open()}function V(o){if(o.geometry&&o.geometry.dispose(),o.material){let a=function(e){e.dispose();for(const t in e)e[t]&&e[t].isTexture&&e[t].dispose()};Array.isArray(o.material)?o.material.forEach(a):a(o.material)}}function J(o){k&&(k.traverse(V),w.traverse(V),p.traverse(V),f.remove(k,w,p)),q=null,k=null,p=null,w=null,g.length=0,L.clear(),T.clear(),d=-1,W++;const a=W;o.then(({goalMap:e,urdf:t,ik:n,helperScale:s=1})=>{if(W!==a)return;n.updateMatrixWorld(!0),p=new Y(n),p.setJointScale(s),p.color.set(15277667),p.setColor(p.color),w=new Y(n),w.setJointScale(s),w.color.set(15277667),w.setColor(w.color),w.setDrawThrough(!0),t.traverse(c=>{c.castShadow=!0,c.receiveShadow=!0}),f.add(t,p,w);const r=[];e.forEach((c,y)=>{r.push(y),L.set(y,c),T.set(c,y)}),i=h.webworker?new F(n):new oe(n),i.maxIterations=3,i.translationErrorClamp=.25,i.rotationErrorClamp=.25,i.restPoseFactor=.01,i.divergeThreshold=.05,r.length?(l.position.set(...r[0].position),l.quaternion.set(...r[0].quaternion),d=0):d=-1,r.forEach(c=>{c.originalPosition=[0,0,0],c.originalQuaternion=[0,0,0,1]}),q=n,k=t,g.push(...r),ae()})}
