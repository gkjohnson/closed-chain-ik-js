import{h as _,B as $,i as Z,V as ee,W as te,e as oe,P as ne,S as ae,C as B,D as se,A as ie,G as Q,M as V,j as z,k as J,I as U,g as re,c as N,R as le,J as de,L as ce,b as ue,d as pe}from"./IKRootsHelper-COUPCDCE.js";import{S as he,O as me,T as we}from"./stats.module-BmaK_bvY.js";import{l as fe,a as ge,b as ve,c as Se,d as be,e as xe,W as P}from"./loadModels-BQg7RtQk.js";import{a as ye}from"./URDFLoader-BGE-E6rN.js";const O={ATHLETE:xe,Robonaut:be,Curiosity:Se,Staubli:ve,Digit:ge,Spot:fe},l={solve:!0,displayMesh:!0,displayIk:!0,displayGoals:!0,displayShadows:!0,model:"ATHLETE",webworker:!0},S={useSVD:!1,maxIterations:6,divergeThreshold:.05,stallThreshold:1e-4,translationErrorClamp:.25,rotationErrorClamp:.25,translationConvergeThreshold:.001,rotationConvergeThreshold:1e-5,restPoseFactor:.025},q=new Map,M=new Map,c=[],C=[];let r=-1,w,A,X,h,f,x,g,G,u,s,i,d,p,L,b,R=0,j=0,D=0;const I=new _,Ce=new $,E=new Z,F=new ee;Me();K();H(O[l.model]());function Me(){A=new he,document.body.appendChild(A.dom),X=document.getElementById("output"),h=new te({antialias:!0}),h.setPixelRatio(window.devicePixelRatio),h.setSize(window.innerWidth,window.innerHeight),h.shadowMap.enabled=!0,h.shadowMap.type=oe,h.setAnimationLoop(qe),document.body.appendChild(h.domElement),x=new ne(50,window.innerWidth/window.innerHeight),x.position.set(8,8,8),f=new ae,f.background=new B(1250841),g=new se(16777215,3),g.position.set(1,3,2),g.castShadow=!0,g.shadow.mapSize.setScalar(2048),f.add(g,g.target);const e=new ie(2503224,3);f.add(e),G=new me(x,h.domElement),s=new Q,s.position.set(0,1,1),f.add(s),u=new we(x,h.domElement),u.setSpace("local"),u.attach(s),f.add(u.getHelper()),u.addEventListener("mouseDown",()=>G.enabled=!1),u.addEventListener("mouseUp",()=>G.enabled=!0),window.addEventListener("resize",()=>{const t=window.innerWidth,o=window.innerHeight;h.setSize(t,o),x.aspect=t/o,x.updateProjectionMatrix()}),window.addEventListener("keydown",t=>{switch(t.key){case"w":u.setMode("translate");break;case"e":u.setMode("rotate");break;case"q":u.setSpace(u.space==="local"?"world":"local");break;case"f":x.position.sub(G.target),G.target.set(0,0,0),G.update();break}r!==-1&&(t.code==="Delete"||t.code==="Backspace")&&(Y(c[r]),r=-1)}),u.addEventListener("mouseUp",()=>{if(r===-1)return;const t=c[r],o=q.get(t);o&&(o.updateMatrixWorld(),o.attachChild(t),t.setPosition(...t.originalPosition),t.setQuaternion(...t.originalQuaternion),o.detachChild(t),s.position.set(...t.position),s.quaternion.set(...t.quaternion))}),h.domElement.addEventListener("pointerdown",t=>{I.x=t.clientX,I.y=t.clientY}),h.domElement.addEventListener("pointerup",t=>{if(Math.abs(t.clientX-I.x)>3||Math.abs(t.clientY-I.y)>3||!b)return;const{ikLink:o,result:n}=Ge(t);o===null&&(r=-1),t.button===2?Ee(o,n):t.button===0&&Te(o,n)})}function Ee(e,t){if(!e)return;M.has(e)&&Y(M.get(e));const o=new de;o.name="GoalRootJoint-"+e.name,o.setPosition(t.point.x,t.point.y,t.point.z);const n=new ce;o.addChild(n);const a=new ue;a.name="GoalJoint-"+e.name,e.getWorldPosition(a.position),e.getWorldQuaternion(a.quaternion),a.setMatrixNeedsUpdate(),n.attachChild(a),a.makeClosure(e),e.attachChild(o),o.originalPosition=o.position.slice(),o.originalQuaternion=o.quaternion.slice(),e.detachChild(o),i.updateStructure(),d.updateStructure(),p.updateStructure(),s.position.set(...o.position),s.quaternion.set(...o.quaternion),q.set(o,e),M.set(e,o),c.push(o),r=c.length-1}function Te(e,t){if(!u.dragging){if(r=C.indexOf(t?t.object.parent:null),r!==-1){const o=c[r];s.position.set(...o.position),s.quaternion.set(...o.quaternion)}else if(e&&M.has(e)){const o=M.get(e);r=c.indexOf(o),s.position.set(...o.position),s.quaternion.set(...o.quaternion)}}}function Y(e){const t=c.indexOf(e);e.traverse(n=>{n.isClosure&&n.removeChild(n.child)}),c.splice(t,1);const o=q.get(e);q.delete(e),M.delete(o),i.updateStructure(),d.updateStructure(),p.updateStructure()}function Ge(e){const t=new le,o=new _;o.x=e.clientX/window.innerWidth*2-1,o.y=-(e.clientY/window.innerHeight)*2+1,t.setFromCamera(o,x);const n=C.slice(0,c.length);let a=t.intersectObjects(n,!0);if(a.length!==0)return{ikLink:null,result:a[0]};if(a=t.intersectObjects([b],!0),a.length===0)return{ikLink:null,result:null};const y=a[0];let m=null,v=null;return y.object.traverseAncestors(T=>{m===null&&T.isURDFLink&&(m=T,L.traverse(k=>{k.name===m.name&&(v=k)}))}),{ikLink:v,result:y}}function qe(){L&&(Le(),l.solve&&Ie(),Oe(),je()),Pe(),u.enabled=r!==-1,u.getHelper().visible=r!==-1,h.render(f,x),A.update()}function Le(){const e=c[r];e&&(e.setPosition(s.position.x,s.position.y,s.position.z),e.setQuaternion(s.quaternion.x,s.quaternion.y,s.quaternion.z,s.quaternion.w))}function Ie(){const e=window.performance.now();let t;i instanceof P?(i.updateFrameState(...c),i.updateSolverSettings(S),t=i.status,i.running||i.solve()):(Object.assign(i,S),t=i.solve());const o=window.performance.now()-e;D<50&&D++,j+=(o-j)/D,X.innerText=`solve time 	: ${o.toFixed(3)}ms
avg solve time 	: ${j.toFixed(3)}ms
`+t.map(n=>pe[n]).join(`
`),ye(b,L)}function Oe(){b.visible=l.displayMesh,!l.displayIk&&d.parent?f.remove(d,p):l.displayIk&&!d.parent&&f.add(d,p)}function Pe(){for(;C.length<c.length;)C.push(Re());C.forEach(e=>e.visible=!1),c.forEach((e,t)=>{C[t].position.set(...e.position),C[t].quaternion.set(...e.quaternion),C[t].visible=l.displayGoals})}function Re(){const e=new B(16763432),t=new Q,o=new V(new z(.05,30,30),new J({color:e})),n=new V(new z(.05,30,30),new J({color:e,opacity:.4,transparent:!0,depthWrite:!1,depthTest:!1})),a=o.updateMatrix;function y(...m){this.scale.setScalar(this.position.distanceTo(x.position)*.15),a.call(this,...m)}return o.updateMatrix=y,n.updateMatrix=y,t.add(o,n),f.add(t),t}function je(){if(!b)return;Ce.setFromObject(b).getBoundingSphere(E),F.subVectors(g.position,g.target.position),g.target.position.copy(E.center);const e=g.shadow.camera;e.left=e.bottom=-E.radius,e.right=e.top=E.radius,e.near=0,e.far=E.radius*2,e.updateProjectionMatrix(),F.normalize().multiplyScalar(E.radius),g.position.addVectors(E.center,F),g.castShadow=l.displayShadows}function K(){if(w&&w.destroy(),!L)return;w=new re,w.width=350,w.add(l,"model",Object.keys(O)).onChange(t=>{H(O[t]())}),w.add(l,"displayMesh").name("display mesh"),w.add(l,"displayGoals").name("display goals"),w.add(l,"displayIk").name("display ik chains"),w.add(l,"displayShadows").name("shadows"),w.add(l,"webworker").onChange(t=>{t?i=new P(i.roots):(i.dispose(),i=new N(i.roots))}),w.add({reset:()=>H(O[l.model]())},"reset");const e=w.addFolder("solver");e.add(l,"solve").onChange(t=>{!t&&i instanceof P&&i.stop()}),e.add(S,"useSVD"),e.add(S,"maxIterations").min(1).max(15).step(1).listen(),e.add(S,"divergeThreshold").min(0).max(.5).step(.01).listen(),e.add(S,"stallThreshold").min(0).max(.01).step(1e-4).listen(),e.add(S,"translationErrorClamp").min(.01).max(1).listen(),e.add(S,"rotationErrorClamp").min(.01).max(1).listen(),e.add(S,"translationConvergeThreshold").min(.001).max(.1).listen(),e.add(S,"rotationConvergeThreshold").min(1e-5).max(.01).listen(),e.add(S,"restPoseFactor").min(0).max(.25).step(.01).listen(),e.open()}function H(e){b&&(b.traverse(W),p.traverse(W),d.traverse(W),f.remove(b,p,d)),L=null,b=null,d=null,p=null,c.length=0,q.clear(),M.clear(),r=-1,R++;const t=R;e.then(({goalMap:o,urdf:n,ik:a,helperScale:y=1})=>{if(R!==t)return;a.updateMatrixWorld(!0),d=new U(a),d.setJointScale(y),d.color.set(15277667),d.setColor(d.color),p=new U(a),p.setJointScale(y),p.color.set(15277667),p.setColor(p.color),p.setDrawThrough(!0),n.traverse(v=>{v.castShadow=!0,v.receiveShadow=!0}),f.add(n,d,p);const m=[];o.forEach((v,T)=>{m.push(T),q.set(T,v),M.set(v,T)}),i=l.webworker?new P(a):new N(a),m.length?(s.position.set(...m[0].position),s.quaternion.set(...m[0].quaternion),r=0):r=-1,m.forEach(v=>{v.originalPosition=[0,0,0],v.originalQuaternion=[0,0,0,1]}),L=a,b=n,c.push(...m),K()})}function W(e){e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material:[e.material]).forEach(o=>{o.dispose();for(const n in o)o[n]&&o[n].isTexture&&o[n].dispose()})}
