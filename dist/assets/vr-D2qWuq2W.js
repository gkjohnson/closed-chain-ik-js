import{O as Le,j as oe,k as J,M as B,o as Ie,G as _,u as ae,l as se,a0 as ke,a1 as Re,a2 as Oe,B as le,i as Fe,V as re,R as Ge,W as We,e as Be,S as je,C as ye,P as Ue,D as Ve,A as ze,a3 as He,v as qe,a4 as De,_ as Xe,a5 as $e,X as de,K as Qe,a6 as _e,Z as Je,I as ue,a7 as Ke,a8 as Ye,a9 as Ze,J as ce,aa as et,L as tt,Q as st,ab as ot,g as nt,c as xe}from"./IKRootsHelper-COUPCDCE.js";import{G as we,m as it}from"./GLTFLoader-B1LzBeNl.js";import{e as ge,b as ve,c as be,d as Se,W as ne}from"./loadModels-BQg7RtQk.js";import{a as Ee}from"./URDFLoader-BGE-E6rN.js";class H{static createButton(e,t={}){const s=document.createElement("button");function a(){let o=null;async function u(y){y.addEventListener("end",f),await e.xr.setSession(y),s.textContent="EXIT VR",o=y}function f(){o.removeEventListener("end",f),s.textContent="ENTER VR",o=null}s.style.display="",s.style.cursor="pointer",s.style.left="calc(50% - 50px)",s.style.width="100px",s.textContent="ENTER VR";const m={...t,optionalFeatures:["local-floor","bounded-floor","layers",...t.optionalFeatures||[]]};s.onmouseenter=function(){s.style.opacity="1.0"},s.onmouseleave=function(){s.style.opacity="0.5"},s.onclick=function(){o===null?navigator.xr.requestSession("immersive-vr",m).then(u):(o.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",m).then(u).catch(y=>{console.warn(y)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",m).then(u).catch(y=>{console.warn(y)})}function d(){s.style.display="",s.style.cursor="auto",s.style.left="calc(50% - 75px)",s.style.width="150px",s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function l(){d(),s.textContent="VR NOT SUPPORTED"}function n(o){d(),console.warn("Exception when trying to call xr.isSessionSupported",o),s.textContent="VR NOT ALLOWED"}function i(o){o.style.position="absolute",o.style.bottom="20px",o.style.padding="12px 6px",o.style.border="1px solid #fff",o.style.borderRadius="4px",o.style.background="rgba(0,0,0,0.1)",o.style.color="#fff",o.style.font="normal 13px sans-serif",o.style.textAlign="center",o.style.opacity="0.5",o.style.outline="none",o.style.zIndex="999"}if("xr"in navigator)return s.id="VRButton",s.style.display="none",i(s),navigator.xr.isSessionSupported("immersive-vr").then(function(o){o?a():l(),o&&H.xrSessionIsGranted&&s.click()}).catch(n),s;{const o=document.createElement("a");return window.isSecureContext===!1?(o.href=document.location.href.replace(/^http:/,"https:"),o.innerHTML="WEBXR NEEDS HTTPS"):(o.href="https://immersiveweb.dev/",o.innerHTML="WEBXR NOT AVAILABLE"),o.style.left="calc(50% - 90px)",o.style.width="180px",o.style.textDecoration="none",i(o),o}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{H.xrSessionIsGranted=!0})}}}H.xrSessionIsGranted=!1;H.registerSessionGrantedListener();const x={ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function Ae(r){const e=await fetch(r);if(e.ok)return e.json();throw new Error(e.statusText)}async function at(r){if(!r)throw new Error("No basePath supplied");return await Ae(`${r}/profilesList.json`)}async function rt(r,e,t=null,s=!0){if(!r)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No basePath supplied");const a=await at(e);let d;if(r.profiles.some(i=>{const o=a[i];return o&&(d={profileId:i,profilePath:`${e}/${o.path}`,deprecated:!!o.deprecated}),!!d}),!d){if(!t)throw new Error("No matching profile name found");const i=a[t];if(!i)throw new Error(`No matching profile name found and default profile "${t}" missing.`);d={profileId:t,profilePath:`${e}/${i.path}`,deprecated:!!i.deprecated}}const l=await Ae(d.profilePath);let n;if(s){let i;if(r.handedness==="any"?i=l.layouts[Object.keys(l.layouts)[0]]:i=l.layouts[r.handedness],!i)throw new Error(`No matching handedness, ${r.handedness}, in profile ${d.profileId}`);i.assetPath&&(n=d.profilePath.replace("profile.json",i.assetPath))}return{profile:l,assetPath:n}}const lt={xAxis:0,yAxis:0,button:0,state:x.ComponentState.DEFAULT};function dt(r=0,e=0){let t=r,s=e;if(Math.sqrt(r*r+e*e)>1){const l=Math.atan2(e,r);t=Math.cos(l),s=Math.sin(l)}return{normalizedXAxis:t*.5+.5,normalizedYAxis:s*.5+.5}}class ut{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===x.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(lt)}updateFromComponent({xAxis:e,yAxis:t,button:s,state:a}){const{normalizedXAxis:d,normalizedYAxis:l}=dt(e,t);switch(this.componentProperty){case x.ComponentProperty.X_AXIS:this.value=this.states.includes(a)?d:.5;break;case x.ComponentProperty.Y_AXIS:this.value=this.states.includes(a)?l:.5;break;case x.ComponentProperty.BUTTON:this.value=this.states.includes(a)?s:0;break;case x.ComponentProperty.STATE:this.valueNodeProperty===x.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(a):this.value=this.states.includes(a)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class ct{constructor(e,t){if(!e||!t||!t.visualResponses||!t.gamepadIndices||Object.keys(t.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach(s=>{const a=new ut(t.visualResponses[s]);this.visualResponses[s]=a}),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:x.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=x.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||this.values.button===1?this.values.state=x.ComponentState.PRESSED:(t.touched||this.values.button>x.ButtonTouchThreshold)&&(this.values.state=x.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===x.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>x.AxisTouchThreshold&&(this.values.state=x.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===x.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>x.AxisTouchThreshold&&(this.values.state=x.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(t=>{t.updateFromComponent(this.values)})}}class ht{constructor(e,t,s){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=s,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(a=>{const d=this.layoutDescription.components[a];this.components[a]=new ct(a,d)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach(t=>{e.push(t.data)}),e}updateFromGamepad(){Object.values(this.components).forEach(e=>{e.updateFromGamepad(this.xrInputSource.gamepad)})}}const pt="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",ft="generic-trigger";class mt extends Le{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e?this:(this.envMap=e,this.traverse(t=>{t.isMesh&&(t.material.envMap=this.envMap,t.material.needsUpdate=!0)}),this)}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach(t=>{Object.values(t.visualResponses).forEach(s=>{const{valueNode:a,minNode:d,maxNode:l,value:n,valueNodeProperty:i}=s;a&&(i===x.VisualResponseProperty.VISIBILITY?a.visible=n:i===x.VisualResponseProperty.TRANSFORM&&(a.quaternion.slerpQuaternions(d.quaternion,l.quaternion,n),a.position.lerpVectors(d.position,l.position,n)))})}))}}function yt(r,e){Object.values(r.components).forEach(t=>{const{type:s,touchPointNodeName:a,visualResponses:d}=t;if(s===x.ComponentType.TOUCHPAD)if(t.touchPointNode=e.getObjectByName(a),t.touchPointNode){const l=new oe(.001),n=new J({color:255}),i=new B(l,n);t.touchPointNode.add(i)}else console.warn(`Could not find touch dot, ${t.touchPointNodeName}, in touchpad component ${t.id}`);Object.values(d).forEach(l=>{const{valueNodeName:n,minNodeName:i,maxNodeName:o,valueNodeProperty:u}=l;if(u===x.VisualResponseProperty.TRANSFORM){if(l.minNode=e.getObjectByName(i),l.maxNode=e.getObjectByName(o),!l.minNode){console.warn(`Could not find ${i} in the model`);return}if(!l.maxNode){console.warn(`Could not find ${o} in the model`);return}}l.valueNode=e.getObjectByName(n),l.valueNode||console.warn(`Could not find ${n} in the model`)})})}function he(r,e){yt(r.motionController,e),r.envMap&&e.traverse(t=>{t.isMesh&&(t.material.envMap=r.envMap,t.material.needsUpdate=!0)}),r.add(e)}class xt{constructor(e=null,t=null){this.gltfLoader=e,this.path=pt,this._assetCache={},this.onLoad=t,this.gltfLoader||(this.gltfLoader=new we)}setPath(e){return this.path=e,this}createControllerModel(e){const t=new mt;let s=null;return e.addEventListener("connected",a=>{const d=a.data;d.targetRayMode!=="tracked-pointer"||!d.gamepad||d.hand||rt(d,this.path,ft).then(({profile:l,assetPath:n})=>{t.motionController=new ht(d,l,n);const i=this._assetCache[t.motionController.assetUrl];if(i)s=i.scene.clone(),he(t,s),this.onLoad&&this.onLoad(s);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(t.motionController.assetUrl,o=>{this._assetCache[t.motionController.assetUrl]=o,s=o.scene.clone(),he(t,s),this.onLoad&&this.onLoad(s)},null,()=>{throw new Error(`Asset ${t.motionController.assetUrl} missing or malformed.`)})}}).catch(l=>{console.warn(l)})}),e.addEventListener("disconnected",()=>{t.motionController=null,t.remove(s),s=null}),t}}function pe(r){return r.buffer instanceof ArrayBuffer&&"BYTES_PER_ELEMENT"in r}class wt{constructor(){const e=new Set;e.add("uuid"),this.ignoreKeys=e,this.shareTextures=!0}areEqual(e,t){const s=new Set,a=new Set,d=this.ignoreKeys,l=(n,i)=>{if(n===i)return!0;if(n&&i&&n instanceof Object&&i instanceof Object){if(a.has(n)||a.has(i))throw new Error("MaterialReducer: Material is recursive.");const o=n instanceof Element,u=i instanceof Element;if(o||u)return o!==u||!(n instanceof Image)||!(i instanceof Image)?!1:n.src===i.src;if(n.equals)return n.equals(i);const f=pe(n),m=pe(i);if(f||m){if(f!==m||n.constructor!==i.constructor||n.length!==i.length)return!1;for(let c=0,b=n.length;c<b;c++)if(n[c]!==i[c])return!1;return!0}a.add(n),a.add(i),s.clear();for(const c in n)!n.hasOwnProperty(c)||n[c]instanceof Function||d.has(c)||s.add(c);for(const c in i)!i.hasOwnProperty(c)||i[c]instanceof Function||d.has(c)||s.add(c);const y=Array.from(s.values());let h=!0;for(const c in y){const b=y[c];if(!d.has(b)&&(h=l(n[b],i[b]),!h))break}return a.delete(n),a.delete(i),h}return!1};return l(e,t)}process(e){const t=[],s=[];let a=0;const d=l=>{let n=null;for(const i in s){const o=s[i];this.areEqual(l,o)&&(n=o)}if(n)return a++,n;if(s.push(l),this.shareTextures)for(const i in l){if(!l.hasOwnProperty(i))continue;const o=l[i];if(o&&o.isTexture&&o.image instanceof Image){let u=null;for(const f in t){const m=t[f];if(this.areEqual(m,o)){u=m;break}}u?l[i]=u:t.push(o)}}return l};return e.traverse(l=>{if(l.isMesh&&l.material){const n=l.material;if(Array.isArray(n))for(let i=0;i<n.length;i++)n[i]=d(n[i]);else l.material=d(n)}}),{replaced:a,retained:s.length}}}const fe=new Ie;class gt extends Oe{constructor(e,t,s){super(e,t),this.proxied=s}raycast(...e){const{proxied:t}=this;for(let s=0,a=t.length;s<a;s++)t[s].raycast(...e)}updateMatrixWorld(...e){super.updateMatrixWorld(...e);const{geometry:t,matrixWorld:s,proxied:a,frustumCulled:d}=this;if(t.boundingBox||(t.boundingBox=new le),t.boundingSphere||(t.boundingSphere=new Fe),d){const l=t.boundingBox;l.makeEmpty();for(let n=0,i=a.length;n<i;n++)l.expandByObject(a[n]);fe.copy(s).invert(),l.applyMatrix4(fe),l.getBoundingSphere(t.boundingSphere)}}}class vt extends Re{constructor(e){super(),this.proxied=e}updateMatrixWorld(){const{matrixWorld:e,proxied:t}=this;t.updateMatrixWorld(!0),e.copy(t.matrixWorld)}}class bt extends _{get visible(){return this.proxied.visible}set visible(e){this.proxied&&(this.proxied.visible=e)}constructor(e){if(super(),e.parent)throw new Error("ProxyBatchedMesh : Proxied root is not expected to have a parent.");e.parent=this,this.proxied=e;const t=new Map;e.updateMatrixWorld(!0),e.traverse(s=>{if(s.isMesh)if(Array.isArray(s.material)){const a=s.material,d=!!s.geometry.index,l=d?s.geometry.clone().toNonIndexed():s.geometry,n=l.groups,i=l.attributes;n.forEach(o=>{const u=a[o.materialIndex];t.get(u)||t.set(u,[]);const f=new ae;for(const m in i){const y=i[m],h=y.itemSize,c=new se(y.array.slice(h*o.start,h*(o.start+o.count)),y.itemSize,y.normalized);f.setAttribute(m,c)}if(d){const m=f.attributes.position.count,y=new Array(m).fill().map((h,c)=>c);f.setIndex(y)}t.get(u).push({mesh:s,geometry:f})})}else{const a=s.material;t.get(a)||t.set(a,[]),t.get(a).push({mesh:s,geometry:s.geometry})}}),t.forEach((s,a)=>{const d=s.length>256?Uint16Array:Uint8Array,l=[],n=s.map((m,y)=>{const h=m.geometry,c=new ae;for(const j in h.attributes)c.setAttribute(j,h.getAttribute(j));c.setIndex(h.getIndex());const b=c.attributes.position.count,S=new Uint8Array(b*4);for(let j=0,Ne=S.length;j<Ne;j++){const Y=j*4;S[Y]=255,S[Y+1]=0,S[Y+2]=0,S[Y+3]=0}c.setAttribute("skinWeight",new se(S,4,!0)),c.setAttribute("skinIndex",new se(new d(b*4).fill(y),4));const X=new vt(m.mesh);return l.push(X),c}),i=new ke(l),o=it(n),u=new Set(s.map(m=>m.mesh)),f=new gt(o,a,Array.from(u));f.bind(i),f.add(...l),this.add(f)})}updateMatrixWorld(...e){const{proxied:t}=this;return t.parent&&t.parent!==this&&console.warn("ProxyBatchedMesh : Proxy mesh is expected to not have parent."),t.parent===null&&(t.parent=this),this.updateWorldMatrix(!1,!1),t.updateMatrixWorld(...e),super.updateMatrixWorld(...e)}}const p={shadows:!0,liveRaycasting:!0,scale:1,solve:!0,displayIk:!1,displayGoals:!0,model:window.location.hash.replace(/^#/,"").trim()||"ATHLETE",webworker:!0},N={useSVD:!1,maxIterations:3,divergeThreshold:.05,stallThreshold:1e-4,translationErrorClamp:.25,rotationErrorClamp:.25,translationConvergeThreshold:.001,rotationConvergeThreshold:1e-5,restPoseFactor:.025},q=new Map,z=new Map,P=[],k=[];let R=-1,ie=0,A,T,w,K,I,v,Z,F,U,L,V,E,g,M,C,D,O,$,G;const ee=new re,Q=new st,W=new Ge;St();Ce();Me(p.model);function St(){T=new We({antialias:!0}),T.setPixelRatio(window.devicePixelRatio),T.setSize(window.innerWidth,window.innerHeight),T.shadowMap.enabled=!0,T.shadowMap.type=Be,document.body.appendChild(T.domElement),w=new je,w.background=new ye(1250841),I=new _,I.position.z=3,w.add(I),K=new Ue(50,window.innerWidth/window.innerHeight),I.add(K),U=new Ve(16777215,3),U.position.set(5,30,15),U.castShadow=!0,U.shadow.mapSize.set(2048,2048),w.add(U);const r=new ze(2503224,3);w.add(r);const e=new He(10,10,16777215,16777215);e.material.transparent=!0,e.material.opacity=.1,e.material.depthWrite=!1,w.add(e),F=new B(new qe,new De({color:0,opacity:.25,transparent:!0,depthWrite:!1})),F.receiveShadow=!0,F.scale.setScalar(30),F.rotation.x=-Math.PI/2,F.renderOrder=1,w.add(F),E=new _,E.position.set(0,1,1),w.add(E),window.addEventListener("resize",Et),G=new _,G.rotation.set(0,-Math.PI/2,0),G.position.set(.5,0,2.35),w.add(G),new we().load("https://raw.githubusercontent.com/gkjohnson/3d-demo-data/main/models/mars-site/scene.gltf",n=>{const i=n.scene;i.scale.setScalar(.01),i.updateMatrixWorld(!0);const o=new le;o.setFromObject(i),i.position.y=-o.min.y,G.add(i)});const t=new J({color:16777215});L=new B(new Xe(.25,.02,16,100),t),L.rotation.x=Math.PI/2,L.visible=!1,w.add(L),V=new B(new oe(.005,50,50),t),w.add(V),T.xr.enabled=!0,T.setAnimationLoop(Tt),document.body.appendChild(H.createButton(T)),v=T.xr.getController(0),v.addEventListener("connected",function(n){this.add(At(n.data))}),v.addEventListener("disconnected",function(){this.remove(this.children[0])}),I.add(v);const s=new re,a=new re;let d=-1;v.addEventListener("selectend",()=>{if(R!==-1){const n=P[R],i=q.get(n);i&&(i.updateMatrixWorld(),i.attachChild(n),n.setPosition(...n.originalPosition),n.setQuaternion(...n.originalQuaternion),i.detachChild(n),E.position.set(...n.position),E.quaternion.set(...n.quaternion)),a.set(...n.position),s.distanceTo(a)<.01/p.scale&&window.performance.now()-d<500&&me(n),v.remove(E),R=-1}}),v.addEventListener("selectstart",()=>{if(!O)return;const{ikLink:n,result:i}=Te();if(s.setScalar(1/0),n===null){let S=-1;if(i&&(S=k.indexOf(i.object.parent)),R=S,S!==-1){const X=P[S];E.position.set(...X.position),E.quaternion.set(...X.quaternion),v.attach(E),s.set(...X.position),d=window.performance.now()}else S===-1&&L.visible&&(I.position.copy(L.position).addScaledVector(v.position,-1/p.scale),I.position.y=0);return}if(z.has(n)){const S=z.get(n);me(S)}const o=new Ke;o.copy(i.face.normal),o.w=0,o.applyMatrix4(i.object.matrixWorld);const u=Ye(),f=[0,0,0],m=o.toArray();let y=[0,1,0];Math.abs(m[1])>.9&&(y=[0,0,1]),Ze(u,f,m,y);const h=new ce;h.name="GoalRootJoint-"+n.name,h.setPosition(i.point.x,i.point.y,i.point.z),et(h.quaternion,u);const c=new tt;h.addChild(c);const b=new ce;h.name="GoalJoint-"+n.name,n.getWorldPosition(b.position),n.getWorldQuaternion(b.quaternion),b.setMatrixNeedsUpdate(),c.attachChild(b),b.makeClosure(n),n.attachChild(h),h.originalPosition=h.position.slice(),h.originalQuaternion=h.quaternion.slice(),n.detachChild(h),g.updateStructure(),M.updateStructure(),C.updateStructure(),E.position.set(...h.position),E.quaternion.set(...h.quaternion),v.attach(E),q.set(h,n),z.set(n,h),P.push(h),R=P.length-1});const l=new xt;Z=T.xr.getControllerGrip(0),Z.add(l.createControllerModel(Z)),I.add(Z)}function me(r){const e=P.indexOf(r),t=P[e];t.traverse(a=>{a.isClosure&&a.removeChild(a.child)}),P.splice(e,1);const s=q.get(t);q.delete(t),z.delete(s),g.updateStructure(),M.updateStructure(),C.updateStructure()}function Et(){const r=window.innerWidth,e=window.innerHeight,t=r/e;T.setSize(r,e),K.aspect=t,K.updateProjectionMatrix()}function At(r){let e,t;switch(r.targetRayMode){case"tracked-pointer":return e=new ae,e.setAttribute("position",new de([0,0,0,0,0,-1],3)),e.setAttribute("color",new de([.5,.5,.5,0,0,0],3)),t=new Qe({vertexColors:!0,blending:_e,depthWrite:!1,transparent:!0}),new Je(e,t);case"gaze":return e=new $e(.02,.04,32).translate(0,0,-1),t=new J({opacity:.5,transparent:!0}),new B(e,t)}}function Te(r=!1){v.updateMatrixWorld(),W.ray.origin.set(0,0,0).applyMatrix4(v.matrixWorld),W.ray.direction.set(0,0,-1).transformDirection(v.matrixWorld);let e;const t=[...k];if(t.length=t.length<P.length?t.length:P.length,e=W.intersectObjects(t,!0),e.length!==0)return{ikLink:null,result:e[0]};if(r)return{ikLink:null,result:null};if(e=W.intersectObjects([O],!0),e.length===0)return{ikLink:null,result:null};const s=e[0];let a=null,d=null;return s.object.traverseAncestors(l=>{a===null&&l.isURDFLink&&(a=l,D.traverse(n=>{n.name===a.name&&(d=n)}))}),{ikLink:d,result:s}}function Tt(){const r=P,e=r[R];if(D){if(L.visible=!1,V.visible=!1,e)E.getWorldPosition(ee),E.getWorldQuaternion(Q),e.setPosition(ee.x,ee.y,ee.z),e.setQuaternion(Q.x,Q.y,Q.z,Q.w);else{const{result:t}=Te(!p.liveRaycasting),s=v.children[0];if(s&&s.scale.setScalar(1,1,1),t===null){W.ray.origin.set(0,0,0).applyMatrix4(v.matrixWorld),W.ray.direction.set(0,0,-1).transformDirection(v.matrixWorld);const a=W.intersectObject(F)[0];a&&(L.visible=!0,L.position.copy(a.point))}else s&&s.scale.setScalar(t.distance*p.scale),V.position.copy(t.point),V.visible=!0}p.solve&&(g instanceof ne?(g.updateFrameState(...r),g.updateSolverSettings(N),g.running||g.solve()):(Object.assign(g,N),g.solve()),Ee(O,D)),!p.displayIk&&M.parent?(w.remove(M),w.remove(C)):p.displayIk&&!M.parent&&(w.add(M),w.add(C))}for(;k.length<r.length;){const t=new ye(16763432),s=new _,a=new B(new oe(.01,30,30),new J({color:t})),d=new B(new oe(.01,30,30),new J({color:t,opacity:.4,transparent:!0,depthWrite:!1,depthTest:!1}));s.add(a,d),w.add(s),k.push(s)}k.forEach(t=>{t.visible=!1,t.scale.setScalar(1/p.scale)}),r.forEach((t,s)=>{k[s].position.set(...t.position),k[s].quaternion.set(...t.quaternion),k[s].visible=p.displayGoals}),L.scale.setScalar(1/p.scale),V.scale.setScalar(1/p.scale),I.scale.setScalar(1/p.scale),U.castShadow=p.shadows,T.render(w,K)}function Me(r){let e=null;switch(G.visible=!1,r){case"Robonaut":e=Se();break;case"Curiosity":e=be(),G.visible=!0;break;case"Staubli":e=ve();break;default:e=ge();break}Pe(e)}function Ce(){if(A&&A.destroy(),!D)return;A=new nt,A.width=350,A.add(p,"model",["ATHLETE","Robonaut","Curiosity","Staubli"]).onChange(e=>{Me(e)}),A.add(p,"scale",.1,4,.01),A.add(p,"shadows"),A.add(p,"liveRaycasting"),A.add(p,"displayGoals").name("display goals"),A.add(p,"displayIk").name("display ik chains"),A.add(p,"webworker").onChange(e=>{e?g=new ne(g.roots):(g.dispose(),g=new xe(g.roots))}),A.add({reset:()=>{let e=null;switch(p.model){case"ATHLETE":e=ge();break;case"Robonaut":e=Se();break;case"Curiosity":e=be();break;case"Staubli":e=ve();break}Pe(e)}},"reset");const r=A.addFolder("solver");r.add(p,"solve").onChange(e=>{!e&&g instanceof ne&&g.stop()}),r.add(N,"useSVD"),r.add(N,"maxIterations").min(1).max(10).step(1).listen(),r.add(N,"divergeThreshold").min(0).max(.5).step(.01).listen(),r.add(N,"stallThreshold").min(0).max(.01).step(1e-4).listen(),r.add(N,"translationErrorClamp").min(.01).max(1).listen(),r.add(N,"rotationErrorClamp").min(.01).max(1).listen(),r.add(N,"translationConvergeThreshold").min(.001).max(.1).listen(),r.add(N,"rotationConvergeThreshold").min(1e-5).max(.01).listen(),r.add(N,"restPoseFactor").min(0).max(.25).step(.01).listen(),r.open()}function te(r){if(r.geometry&&r.geometry.dispose(),r.material){let e=function(t){t.dispose();for(const s in t)t[s]&&t[s].isTexture&&t[s].dispose()};Array.isArray(r.material)?r.material.forEach(e):e(r.material)}}function Pe(r){O&&(O.traverse(te),C.traverse(te),M.traverse(te),$.traverse(te),w.remove(O,C,M,$)),D=null,O=null,M=null,C=null,P.length=0,q.clear(),z.clear(),R=-1,ie++;const e=ie;r.then(({goalMap:t,urdf:s,ik:a,helperScale:d=1})=>{if(ie!==e)return;s.traverse(o=>{if(o.castShadow=!0,o.receiveShadow=!0,o.material){let u=function(f){return new ot({map:f.map,color:f.color,normalMap:f.normalMap,normalMapType:f.normalMapType})};Array.isArray(o.material)?o.material=o.material.map(u):o.material=u(o.material)}}),new wt().process(s),s.traverse(o=>{if(o.isMesh){if(o.geometry.deleteAttribute("color"),o.geometry.index&&o.geometry.toNonIndexed(),o.geometry.attributes.uv&&!o.material.map)o.geometry.deleteAttribute("uv");else if(!o.geometry.attributes.uv&&o.material.map){const u=o.geometry.attributes.position.count;o.geometry.setAttribute("uv",new se(new Float32Array(u*2),2,!1))}}}),$=new bt(s),$.children.forEach(o=>{o.castShadow=!0,o.receiveShadow=!0,o.material.skinning=!0}),Ee(s,a);const n=new le;s.updateMatrixWorld(!0),n.setFromObject(s),s.position.y-=n.min.y,a.position[1]-=n.min.y,a.setMatrixNeedsUpdate(),t.forEach((o,u)=>{u.position[1]-=n.min.y,u.setMatrixNeedsUpdate()}),a.updateMatrixWorld(!0),M=new ue(a),M.setJointScale(d),M.setColor(15277667),C=new ue(a),C.setJointScale(d),C.setColor(15277667),C.setDrawThrough(!0),w.add($,M,C);const i=[];t.forEach((o,u)=>{i.push(u),q.set(u,o),z.set(o,u)}),g=p.webworker?new ne(a):new xe(a),R=-1,i.forEach(o=>{o.originalPosition=[0,0,0],o.originalQuaternion=[0,0,0,1]}),D=a,O=s,P.push(...i),Ce()})}
