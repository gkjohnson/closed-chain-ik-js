(function(){"use strict";var Qt=1e-6,I=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function De(){var e=new I(9);return I!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function Wt(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function gt(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function ht(e,t){var r=t[0],s=t[1],n=t[2],i=t[3],a=t[4],h=t[5],o=t[6],l=t[7],c=t[8],f=t[9],g=t[10],u=t[11],p=t[12],v=t[13],d=t[14],F=t[15],E=r*h-s*a,w=r*o-n*a,y=r*l-i*a,C=s*o-n*h,m=s*l-i*h,A=n*l-i*o,S=c*v-f*p,M=c*d-g*p,P=c*F-u*p,T=f*d-g*v,W=f*F-u*v,V=g*F-u*d,J=E*V-w*W+y*T+C*P-m*M+A*S;return J?(J=1/J,e[0]=(h*V-o*W+l*T)*J,e[1]=(n*W-s*V-i*T)*J,e[2]=(v*A-d*m+F*C)*J,e[3]=(g*m-f*A-u*C)*J,e[4]=(o*P-a*V-l*M)*J,e[5]=(r*V-n*P+i*M)*J,e[6]=(d*y-p*A-F*w)*J,e[7]=(c*A-g*y+u*w)*J,e[8]=(a*W-h*P+l*S)*J,e[9]=(s*P-r*W-i*S)*J,e[10]=(p*m-v*y+F*E)*J,e[11]=(f*y-c*m-u*E)*J,e[12]=(h*M-a*T-o*S)*J,e[13]=(r*T-s*M+n*S)*J,e[14]=(v*w-p*C-d*E)*J,e[15]=(c*C-f*w+g*E)*J,e):null}function Z(e,t,r){var s=t[0],n=t[1],i=t[2],a=t[3],h=t[4],o=t[5],l=t[6],c=t[7],f=t[8],g=t[9],u=t[10],p=t[11],v=t[12],d=t[13],F=t[14],E=t[15],w=r[0],y=r[1],C=r[2],m=r[3];return e[0]=w*s+y*h+C*f+m*v,e[1]=w*n+y*o+C*g+m*d,e[2]=w*i+y*l+C*u+m*F,e[3]=w*a+y*c+C*p+m*E,w=r[4],y=r[5],C=r[6],m=r[7],e[4]=w*s+y*h+C*f+m*v,e[5]=w*n+y*o+C*g+m*d,e[6]=w*i+y*l+C*u+m*F,e[7]=w*a+y*c+C*p+m*E,w=r[8],y=r[9],C=r[10],m=r[11],e[8]=w*s+y*h+C*f+m*v,e[9]=w*n+y*o+C*g+m*d,e[10]=w*i+y*l+C*u+m*F,e[11]=w*a+y*c+C*p+m*E,w=r[12],y=r[13],C=r[14],m=r[15],e[12]=w*s+y*h+C*f+m*v,e[13]=w*n+y*o+C*g+m*d,e[14]=w*i+y*l+C*u+m*F,e[15]=w*a+y*c+C*p+m*E,e}function $t(e,t,r){var s=t[0],n=t[1],i=t[2],a=t[3],h=s+s,o=n+n,l=i+i,c=s*h,f=s*o,g=s*l,u=n*o,p=n*l,v=i*l,d=a*h,F=a*o,E=a*l;return e[0]=1-(u+v),e[1]=f+E,e[2]=g-F,e[3]=0,e[4]=f-E,e[5]=1-(c+v),e[6]=p+d,e[7]=0,e[8]=g+F,e[9]=p-d,e[10]=1-(c+u),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function $(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Me(e,t){var r=t[0],s=t[1],n=t[2],i=t[4],a=t[5],h=t[6],o=t[8],l=t[9],c=t[10];return e[0]=Math.hypot(r,s,n),e[1]=Math.hypot(i,a,h),e[2]=Math.hypot(o,l,c),e}function G(e,t){var r=new I(3);Me(r,t);var s=1/r[0],n=1/r[1],i=1/r[2],a=t[0]*s,h=t[1]*n,o=t[2]*i,l=t[4]*s,c=t[5]*n,f=t[6]*i,g=t[8]*s,u=t[9]*n,p=t[10]*i,v=a+c+p,d=0;return v>0?(d=Math.sqrt(v+1)*2,e[3]=.25*d,e[0]=(f-u)/d,e[1]=(g-o)/d,e[2]=(h-l)/d):a>c&&a>p?(d=Math.sqrt(1+a-c-p)*2,e[3]=(f-u)/d,e[0]=.25*d,e[1]=(h+l)/d,e[2]=(g+o)/d):c>p?(d=Math.sqrt(1+c-a-p)*2,e[3]=(g-o)/d,e[0]=(h+l)/d,e[1]=.25*d,e[2]=(f+u)/d):(d=Math.sqrt(1+p-a-c)*2,e[3]=(h-l)/d,e[0]=(g+o)/d,e[1]=(f+u)/d,e[2]=.25*d),e}function Ae(e,t){var r=t[0],s=t[1],n=t[2],i=t[3],a=r+r,h=s+s,o=n+n,l=r*a,c=s*a,f=s*h,g=n*a,u=n*h,p=n*o,v=i*a,d=i*h,F=i*o;return e[0]=1-f-p,e[1]=c+F,e[2]=g-d,e[3]=0,e[4]=c-F,e[5]=1-l-p,e[6]=u+v,e[7]=0,e[8]=g+d,e[9]=u-v,e[10]=1-l-f,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Gt(){var e=new I(3);return I!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function ft(e){var t=e[0],r=e[1],s=e[2];return Math.hypot(t,r,s)}function Xt(e,t,r){var s=new I(3);return s[0]=e,s[1]=t,s[2]=r,s}function st(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Yt(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function X(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function Pe(e,t){var r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return Math.hypot(r,s,n)}function Te(e,t){var r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return r*r+s*s+n*n}function Se(e,t){var r=t[0],s=t[1],n=t[2],i=r*r+s*s+n*n;return i>0&&(i=1/Math.sqrt(i)),e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}function Ve(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function mt(e,t,r){var s=t[0],n=t[1],i=t[2],a=r[0],h=r[1],o=r[2];return e[0]=n*o-i*h,e[1]=i*a-s*o,e[2]=s*h-n*a,e}function Je(e,t,r){var s=t[0],n=t[1],i=t[2],a=r[3]*s+r[7]*n+r[11]*i+r[15];return a=a||1,e[0]=(r[0]*s+r[4]*n+r[8]*i+r[12])/a,e[1]=(r[1]*s+r[5]*n+r[9]*i+r[13])/a,e[2]=(r[2]*s+r[6]*n+r[10]*i+r[14])/a,e}function We(e,t,r){var s=r[0],n=r[1],i=r[2],a=r[3],h=t[0],o=t[1],l=t[2],c=n*l-i*o,f=i*h-s*l,g=s*o-n*h,u=n*g-i*f,p=i*c-s*g,v=s*f-n*c,d=a*2;return c*=d,f*=d,g*=d,u*=2,p*=2,v*=2,e[0]=h+c+u,e[1]=o+f+p,e[2]=l+g+v,e}var Le=Te,Re=ft;(function(){var e=Gt();return function(t,r,s,n,i,a){var h,o;for(r||(r=3),s||(s=0),n?o=Math.min(n*r+s,t.length):o=t.length,h=s;h<o;h+=r)e[0]=t[h],e[1]=t[h+1],e[2]=t[h+2],i(e,e,a),t[h]=e[0],t[h+1]=e[1],t[h+2]=e[2];return t}})();function ke(){var e=new I(4);return I!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function Zt(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}function Ue(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e}function Ot(e,t){var r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2],i=t[3]-e[3];return r*r+s*s+n*n+i*i}function be(e){var t=e[0],r=e[1],s=e[2],n=e[3];return t*t+r*r+s*s+n*n}function Ne(e,t){var r=t[0],s=t[1],n=t[2],i=t[3],a=r*r+s*s+n*n+i*i;return a>0&&(a=1/Math.sqrt(a)),e[0]=r*a,e[1]=s*a,e[2]=n*a,e[3]=i*a,e}(function(){var e=ke();return function(t,r,s,n,i,a){var h,o;for(r||(r=4),s||(s=0),n?o=Math.min(n*r+s,t.length):o=t.length,h=s;h<o;h+=r)e[0]=t[h],e[1]=t[h+1],e[2]=t[h+2],e[3]=t[h+3],i(e,e,a),t[h]=e[0],t[h+1]=e[1],t[h+2]=e[2],t[h+3]=e[3];return t}})();function Ht(){var e=new I(4);return I!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function ze(e,t,r){r=r*.5;var s=Math.sin(r);return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=Math.cos(r),e}function qe(e,t){var r=Math.acos(t[3])*2,s=Math.sin(r/2);return s>Qt?(e[0]=t[0]/s,e[1]=t[1]/s,e[2]=t[2]/s):(e[0]=1,e[1]=0,e[2]=0),r}function Ie(e,t,r){var s=t[0],n=t[1],i=t[2],a=t[3],h=r[0],o=r[1],l=r[2],c=r[3];return e[0]=s*c+a*h+n*l-i*o,e[1]=n*c+a*o+i*h-s*l,e[2]=i*c+a*l+s*o-n*h,e[3]=a*c-s*h-n*o-i*l,e}function Lt(e,t,r,s){var n=t[0],i=t[1],a=t[2],h=t[3],o=r[0],l=r[1],c=r[2],f=r[3],g,u,p,v,d;return u=n*o+i*l+a*c+h*f,u<0&&(u=-u,o=-o,l=-l,c=-c,f=-f),1-u>Qt?(g=Math.acos(u),p=Math.sin(g),v=Math.sin((1-s)*g)/p,d=Math.sin(s*g)/p):(v=1-s,d=s),e[0]=v*n+d*o,e[1]=v*i+d*l,e[2]=v*a+d*c,e[3]=v*h+d*f,e}function _e(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e}function Qe(e,t){var r=t[0]+t[4]+t[8],s;if(r>0)s=Math.sqrt(r+1),e[3]=.5*s,s=.5/s,e[0]=(t[5]-t[7])*s,e[1]=(t[6]-t[2])*s,e[2]=(t[1]-t[3])*s;else{var n=0;t[4]>t[0]&&(n=1),t[8]>t[n*3+n]&&(n=2);var i=(n+1)%3,a=(n+2)%3;s=Math.sqrt(t[n*3+n]-t[i*3+i]-t[a*3+a]+1),e[n]=.5*s,s=.5/s,e[3]=(t[i*3+a]-t[a*3+i])*s,e[i]=(t[i*3+n]+t[n*3+i])*s,e[a]=(t[a*3+n]+t[n*3+a])*s}return e}function Ft(e,t,r,s){var n=.5*Math.PI/180;t*=n,r*=n,s*=n;var i=Math.sin(t),a=Math.cos(t),h=Math.sin(r),o=Math.cos(r),l=Math.sin(s),c=Math.cos(s);return e[0]=i*o*c-a*h*l,e[1]=a*h*c+i*o*l,e[2]=a*o*l-i*h*c,e[3]=a*o*c+i*h*l,e}var Rt=Ne;(function(){var e=Gt(),t=Xt(1,0,0),r=Xt(0,1,0);return function(s,n,i){var a=Ve(n,i);return a<-.999999?(mt(e,t,n),Re(e)<1e-6&&mt(e,r,n),Se(e,e),ze(s,e,Math.PI),s):a>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(mt(e,n,i),s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1+a,Rt(s,s))}})(),(function(){var e=Ht(),t=Ht();return function(r,s,n,i,a,h){return Lt(e,s,a,h),Lt(t,n,i,h),Lt(r,e,t,2*h*(1-h)),r}})(),(function(){var e=De();return function(t,r,s,n){return e[0]=s[0],e[3]=s[1],e[6]=s[2],e[1]=n[0],e[4]=n[1],e[7]=n[2],e[2]=-r[0],e[5]=-r[1],e[8]=-r[2],Rt(t,Qe(t,e))}})();const dt=new Float64Array(4),wt=new Float64Array(4);function $e(e,t,r){Ue(dt,r,-1),Ot(t,dt)<Ot(t,r)?Zt(e,t,dt):Zt(e,t,r)}function Ge(e,t){Rt(dt,t);let r=qe(e,dt);r>Math.PI&&(r-=2*Math.PI),X(e,e,r)}function Xe(e,t,r){_e(wt,r),Ie(e,t,wt)}function Ye(e,t){return $e(wt,e,t),be(wt)}const O=Math.PI,nt=2*O,Ze=O/2,yt=Math.PI/180,z=1/yt,Oe=[new Float64Array([1,0,0]),new Float64Array([0,1,0]),new Float64Array([0,0,1]),new Float64Array([1,0,0]),new Float64Array([0,1,0]),new Float64Array([0,0,1])],ot=new Float32Array(16),Et=new Float32Array(16),q=new Float32Array(4),it=new Float32Array(3),Kt=new Set,He=[];let H=!1;class Bt{constructor(){this.name="",this.quaternion=new Float32Array([0,0,0,1]),this.position=new Float32Array(3),this.matrix=new Float32Array(16),gt(this.matrix),this.matrixWorld=new Float32Array(16),gt(this.matrixWorld),this.matrixNeedsUpdate=!1,this.matrixWorldNeedsUpdate=!1,this.parent=null,this.children=[]}setPosition(...t){const r=this.position;Le(r,t)>1e-10&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],this.setMatrixNeedsUpdate())}setEuler(t,r,s){Ft(q,t*z,r*z,s*z),this.setQuaternion(...q)}setQuaternion(...t){const r=this.quaternion;Ye(r,t)>1e-10&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],this.setMatrixNeedsUpdate())}setWorldPosition(t,r,s){const n=this.parent;it[0]=t,it[1]=r,it[2]=s,n&&(n.updateMatrixWorld(),ht(ot,n.matrixWorld),Je(it,it,ot)),this.setPosition(...it)}setWorldEuler(t,r,s){Ft(q,t*z,r*z,s*z),this.setWorldQuaternion(...q)}setWorldQuaternion(t,r,s,n){const i=this;q[0]=t,q[1]=r,q[2]=s,q[3]=n,i&&(i.updateMatrixWorld(),ht(ot,i.matrixWorld),Ae(Et,q),Z(Et,ot,Et),G(q,Et)),this.setQuaternion(...q)}getWorldPosition(t){this.updateMatrixWorld(),$(t,this.matrixWorld)}getWorldQuaternion(t){this.updateMatrixWorld(),G(t,this.matrixWorld)}traverseParents(t){let r;const s=H;H?r=new Set:(r=Kt,r.clear()),H=!0;let n=this.parent;for(;n&&!r.has(n);){if(t(n))return;r.add(n),n=n.parent}H=s,r.clear()}traverse(t){const r=H;let s,n;H?(s=new Set,n=[this]):(s=Kt,s.clear(),n=He,n[0]=this),H=!0;let i=0,a=1;for(;i<a;){const h=n[i];if(!t(h)){const l=h.children;for(let c=0,f=l.length;c<f;c++){const g=l[c];s.has(g)||(s.add(g),n[a]=g,a++)}}i++}H=r,s.clear(),n.fill(null)}find(t){let r=null;return this.traverse(s=>{if(r)return!0;if(t(s))return r=s,!0}),r}addChild(t){if(t.parent)throw new Error("Frame: Added child must not already have a parent.");if(t===this)throw new Error("Frame: Frame cannot be added as a child to itself.");this.traverseParents(r=>{if(r===t)throw new Error("Frame: Added child is an ancestor of this Frame. Use Joint.makeClosure instead.")}),t.parent=this,this.children.push(t),t.setMatrixWorldNeedsUpdate()}removeChild(t){if(t.parent!==this)throw new Error("Frame: Child to be removed is not a child of this Frame.");const r=this.children.indexOf(t);this.children.splice(r,1),t.parent=null,t.setMatrixWorldNeedsUpdate()}attachChild(t){this.updateMatrixWorld(),t.updateMatrixWorld(),this.addChild(t),ht(ot,this.matrixWorld),Z(t.matrix,ot,t.matrixWorld),$(t.position,t.matrix),G(t.quaternion,t.matrix)}detachChild(t){this.updateMatrixWorld(),t.updateMatrixWorld(),this.removeChild(t),Wt(t.matrix,t.matrixWorld),$(t.position,t.matrix),G(t.quaternion,t.matrix)}computeMatrixWorld(){this.parent?Z(this.matrixWorld,this.parent.matrixWorld,this.matrix):Wt(this.matrixWorld,this.matrix)}setMatrixNeedsUpdate(){this.matrixNeedsUpdate===!1&&(this.matrixNeedsUpdate=!0,this.setMatrixWorldNeedsUpdate())}setMatrixWorldNeedsUpdate(){this.traverse(t=>t.matrixWorldNeedsUpdate?!0:(t.matrixWorldNeedsUpdate=!0,!1))}updateMatrix(){this.matrixNeedsUpdate&&($t(this.matrix,this.quaternion,this.position),this.matrixNeedsUpdate=!1)}updateMatrixWorld(t=!1){const{parent:r}=this;this.matrixWorldNeedsUpdate&&(r&&r.matrixWorldNeedsUpdate&&r.updateMatrixWorld(!1),this.updateMatrix(),this.computeMatrixWorld(),this.matrixWorldNeedsUpdate=!1),t&&this.traverse(s=>{this!==s&&s.updateMatrixWorld(!1)})}}function kt(e){let t=e%nt;return t>O?t-=nt:t<=-O&&(t+=nt),t}function B(e,t){const r=Math.round(e/nt)*nt,s=kt(t);let n=r+s;const i=n-e;return Math.abs(i)>O&&(n-=Math.sign(i)*nt),n}function Ut(e,t,r){e[0]=B(t[0],r[0]),e[1]=B(t[1],r[1]),e[2]=B(t[2],r[2])}function Ct(e,t){return Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1])+Math.abs(e[2]-t[2])}function jt(e,t){e[0]=t[0]+O,e[1]=O-t[1],e[2]=t[2]+O}function te(e){const t=kt(e[1]);return!(Math.abs(Math.abs(t)-Ze)>1e-7)}function ee(e,t,r){if(!te(r))return!1;const s=kt(r[1]),n=-1*Math.sign(s),i=r[0]+n*r[2];return e[0]=t[0],e[1]=B(t[1],r[1]),e[2]=B(t[2],n*(i-t[0])),Ut(e,t,e),!0}const at=new Float64Array(3),_=new Float64Array(3);function bt(e,t,r){let s=1/0;if(te(r)){ee(at,t,r),jt(_,r),ee(_,t,_);const a=Ct(t,at),h=Ct(t,_);a<h?(st(e,at),s=a):(st(e,_),s=h)}Ut(at,t,r),jt(_,r),Ut(_,t,_);const n=Ct(t,at),i=Ct(t,_);(n<s||i<s)&&(n<i?st(e,at):st(e,_))}const re=new Float64Array(3),xt=new Float64Array(4),se=new Float64Array(3),ne=new Float64Array(4);function Ke(e,t){const[r,s,n,i]=t,a=2*(i*r+s*n),h=1-2*(r*r+s*s),o=Math.atan2(a,h);let l=2*(i*s-n*r);l=l>1?1:l,l=l<-1?-1:l;const c=Math.asin(l),f=2*(i*n+r*s),g=1-2*(s*s+n*n),u=Math.atan2(f,g);return e[0]=o*z,e[1]=c*z,e[2]=u*z,e}function Be(e,t,r,s){$(re,e),G(xt,e),$(se,t),G(ne,t),Yt(r,re,se),Xe(xt,xt,ne),Ge(s,xt)}const D={X:0,Y:1,Z:2,EX:3,EY:4,EZ:5},je=Object.entries(D).sort((e,t)=>e[1]-t[1]).map(e=>e[0]),Dt=new Float32Array(16),oe=new Float32Array(4),L=new Float32Array(3),ut=new Float32Array(3),j=new Float32Array(3);function tr(e,t){Ft(oe,t[D.EX]*z,t[D.EY]*z,t[D.EZ]*z),$t(e,oe,t)}class ie extends Bt{constructor(){super(),this.isJoint=!0,this.child=null,this.isClosure=!1,this.trackJointWrap=!1,this.rotationDoFCount=0,this.translationDoFCount=0,this.dof=[],this.dofFlags=new Uint8Array(6),this.dofValues=new Float32Array(6),this.dofTarget=new Float32Array(6),this.dofRestPose=new Float32Array(6),this.minDoFLimit=new Float32Array(6).fill(-1/0),this.maxDoFLimit=new Float32Array(6).fill(1/0),this.targetSet=!1,this.restPoseSet=!1,this.matrixDoFNeedsUpdate=!1,this.matrixDoF=new Float32Array(16),gt(this.matrixDoF),this.cachedIdentityDoFMatrixWorld=new Float32Array(16),gt(this.cachedIdentityDoFMatrixWorld)}_getQuaternion(t,r){Ft(r,t[D.EX],t[D.EY],t[D.EZ])}_getEuler(t,r){r[0]=t[D.EX],r[1]=t[D.EY],r[2]=t[D.EZ]}_getPosition(t,r){r[0]=t[D.X],r[1]=t[D.Y],r[2]=t[D.Z]}_setValue(t,r,s){if(t===this.minDoFLimit||t==this.maxDoFLimit)throw new Error("Joint: Cannot set minDoFLimit or maxDoFLimit with _setValue.");if(r<0||r>6||typeof r!="number")throw new Error("Joint: Invalid DoF.");if(!this.dofFlags[r])return!1;const n=this.minDoFLimit[r],i=this.maxDoFLimit[r];return s<n&&(s=n),s>i&&(s=i),t[r]=s,s===i||s===n}_setValues(t,r){const s=this.dof;for(let n=0,i=r.length;n<i;n++)this._setValue(t,s[n],r[n])}_setViaFullPosition(t,r){const s=this.dofFlags;for(let n=0;n<3;n++)t[n]=s[n]*r[n]}_setViaFullEuler(t,r){const s=this.dofFlags;for(let n=3;n<6;n++)t[n]=s[n]*r[n-3];this.tryMinimizeEulerAngles()}_setViaQuaternion(t,r){if(Ke(j,r),j[0]*=yt,j[1]*=yt,j[2]*=yt,this.trackJointWrap){const s=this.dofValues;L[0]=s[D.EX],L[1]=s[D.EY],L[2]=s[D.EZ],bt(j,L,j)}this._setViaFullEuler(t,j)}clearDoF(){this.setDoF()}setDoF(...t){t.forEach((r,s)=>{if(r<0||r>=6)throw new Error("Joint: Invalid degree of freedom enum "+r+".");if(t.includes(r,s+1))throw new Error("Joint: Duplicate degree of freedom "+je[r]+"specified.");if(s!==0&&t[s-1]>r)throw new Error("Joint: Joints degrees of freedom must be specified in position then rotation, XYZ order")}),this.dof=t,this.dofValues.fill(0),this.dofTarget.fill(0),this.dofRestPose.fill(0),this.minDoFLimit.fill(-1/0),this.maxDoFLimit.fill(1/0),this.setMatrixDoFNeedsUpdate();for(let r=0;r<6;r++)this.dofFlags[r]=Number(t.includes(r));this.rotationDoFCount=this.dofFlags[D.EX]+this.dofFlags[D.EY]+this.dofFlags[D.EZ],this.translationDoFCount=this.dofFlags[D.X]+this.dofFlags[D.Y]+this.dofFlags[D.Z]}setDoFValues(...t){this.setMatrixDoFNeedsUpdate(),this._setValues(this.dofValues,t)}setDoFValue(t,r){return this.setMatrixDoFNeedsUpdate(),this._setValue(this.dofValues,t,r)}getDoFValue(t){return this.dofValues[t]}getDoFQuaternion(t){this._getQuaternion(this.dofValues,t)}getDoFEuler(t){this._getEuler(this.dofValues,t)}getDoFPosition(t){this._getPosition(this.dofValues,t)}setRestPoseValues(...t){this._setValues(this.dofRestPose,t)}setRestPoseValue(t,r){return this._setValue(this.dofRestPose,t,r)}getRestPoseValue(t){return this.dofRestPose[t]}getRestPoseQuaternion(t){this._getQuaternion(this.dofRestPose,t)}getRestPoseEuler(t){this._getEuler(this.dofRestPose,t)}getRestPosePosition(t){this._getPosition(this.dofRestPose,t)}setTargetValues(...t){this._setValues(this.dofTarget,t)}setTargetValue(t,r){this._setValue(this.dofTarget,t,r)}getTargetValue(t){return this.dofTarget[t]}getTargetQuaternion(t){this._getQuaternion(this.dofTarget,t)}getTargetEuler(t){this._getEuler(this.dofTarget,t)}getTargetPosition(t){this._getPosition(this.dofTarget,t)}setMinLimits(...t){const{dof:r}=this;for(const s in t){const n=r[s];this.setMinLimit(n,t[s])}}setMinLimit(t,r){this.minDoFLimit[t]=r,this.setDoFValue(t,this.dofValues[t])}getMinLimit(t){return this.minDoFLimit[t]}setMaxLimits(...t){const{dof:r}=this;for(const s in t){const n=r[s];this.setMaxLimit(n,t[s])}}setMaxLimit(t,r){this.maxDoFLimit[t]=r,this.setDoFValue(t,this.dofValues[t])}getMaxLimit(t){return this.maxDoFLimit[t]}getClosureError(t,r){if(!this.isClosure)throw new Error("Joint: Cannot get closure error on non closure Joint.");this.updateMatrixWorld(),this.child.updateMatrixWorld(),Be(this.matrixWorld,this.child.matrixWorld,t,r)}tryMinimizeEulerAngles(){const{trackJointWrap:t,rotationDoFCount:r,dofRestPose:s,dofTarget:n,dofValues:i}=this;if(!t)if(r<3)for(let a=D.EX;a<=D.EZ;a++)n[a]=B(i[a],n[a]),s[a]=B(i[a],s[a]);else ut[0]=i[D.EX],ut[1]=i[D.EY],ut[2]=i[D.EZ],L[0]=n[D.EX],L[1]=n[D.EY],L[2]=n[D.EZ],bt(L,ut,L),n[D.EX]=L[0],n[D.EY]=L[1],n[D.EZ]=L[2],L[0]=s[D.EX],L[1]=s[D.EY],L[2]=s[D.EZ],bt(L,ut,L),s[D.EX]=L[0],s[D.EY]=L[1],s[D.EZ]=L[2]}setMatrixDoFNeedsUpdate(){this.matrixDoFNeedsUpdate===!1&&(this.matrixDoFNeedsUpdate=!0,this.setMatrixWorldNeedsUpdate())}updateDoFMatrix(){this.matrixDoFNeedsUpdate&&(tr(this.matrixDoF,this.dofValues),this.matrixDoFNeedsUpdate=!1)}computeMatrixWorld(){const{parent:t,matrixWorld:r,matrix:s,matrixDoF:n,cachedIdentityDoFMatrixWorld:i}=this;this.updateDoFMatrix(),Z(r,s,n),t?(Z(r,t.matrixWorld,r),Z(i,t.matrixWorld,s)):Wt(i,s)}makeClosure(t){if(!t.isLink||this.child||t.parent===this)throw new Error("Joint: Given child cannot be used to make closure.");this.child=t,this.isClosure=!0,t.closureJoints.push(this)}addChild(t){if(!t.isLink||this.child||t.parent===this)throw new Error("Joint: Given child cannot be added to Joint.");super.addChild(t),this.child=t,this.isClosure=!1}removeChild(t){if(this.isClosure){if(this.child!==t)throw new Error("Frame: Child to be removed is not a child of this Joint.");{this.child=null,this.isClosure=!1;const r=t.closureJoints.indexOf(this);t.closureJoints.splice(r,1)}}else super.removeChild(t)}attachChild(t){super.attachChild(t),ht(Dt,this.matrixDoF),Z(t.matrix,Dt,t.matrix),$(t.position,t.matrix),G(t.quaternion,t.matrix)}detachChild(t){super.detachChild(t),ht(Dt,this.matrixDoF),Z(t.matrix,Dt,t.matrix),$(t.position,t.matrix),G(t.quaternion,t.matrix)}}function er(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Mt={exports:{}},ae;function rr(){return ae||(ae=1,(function(e,t){var r=(function(){function s(i,a){this.data=new Array(i.length);for(var h=0,o=i[0].length;h<i.length;h++){this.data[h]=new Array(o);for(var l=0;l<o;l++)this.data[h][l]=i[h][l]}if(a){if(typeof a[0]!="object")for(var h=0;h<a.length;h++)a[h]=[a[h]];this.mirror=new s(a)}}s.prototype.swap=function(i,a){this.mirror&&this.mirror.swap(i,a);var h=this.data[i];this.data[i]=this.data[a],this.data[a]=h},s.prototype.multline=function(i,a){this.mirror&&this.mirror.multline(i,a);for(var h=this.data[i],o=h.length-1;o>=0;o--)h[o]*=a},s.prototype.addmul=function(i,a,h){this.mirror&&this.mirror.addmul(i,a,h);for(var o=this.data[i],l=this.data[a],c=o.length-1;c>=0;c--)o[c]=o[c]+h*l[c]},s.prototype.hasNullLine=function(i){for(var a=0;a<this.data[i].length;a++)if(this.data[i][a]!==0)return!1;return!0},s.prototype.gauss=function(){for(var i=0,a=this.data.length,h=this.data[0].length,o=[],l=0;l<h;l++){for(var c=0,f=0,g=i;g<a;g++){var u=this.data[g][l];Math.abs(u)>Math.abs(c)&&(f=g,c=u)}if(c===0)o.push(i);else{this.multline(f,1/c),this.swap(f,i);for(var p=0;p<a;p++)p!==i&&this.addmul(p,i,-this.data[p][l])}i++}for(var p=0;p<o.length;p++)if(!this.mirror.hasNullLine(o[p]))throw new Error("singular matrix");return this.mirror.data},t.solve=function(a,h){var o=new s(a,h).gauss();if(o.length>0&&o[0].length===1)for(var l=0;l<o.length;l++)o[l]=o[l][0];return o};function n(i){for(var a=new Array(i),h=0;h<i;h++){a[h]=new Array(i);for(var o=0;o<i;o++)a[h][o]=h===o?1:0}return a}return t.invert=function(a){return new s(a,n(a.length)).gauss()},t})();e.exports=r})(Mt,Mt.exports)),Mt.exports}var sr=rr(),le=er(sr),nr=function(t,r,s,n,i){if(r=r!==void 0?r:!0,s=s!==void 0?s:!0,n=n||Math.pow(2,-52),i=1e-64/n,!t)throw new TypeError("Matrix a is not defined");var a=t[0].length,h=t.length;if(h<a)throw new TypeError("Invalid matrix: m < n");var o,l,c,f,g,u,p,v,d,F,E,w,y;v=0,E=0;var C=[],m=[],A=[],S=r==="f"?h:a;for(o=0;o<h;o++)m[o]=new Array(S).fill(0);for(o=0;o<a;o++)A[o]=new Array(a).fill(0);var M=new Array(a).fill(0);for(o=0;o<h;o++)for(l=0;l<a;l++)m[o][l]=t[o][l];for(o=0;o<a;o++){for(C[o]=v,F=0,f=o+1,l=o;l<h;l++)F+=Math.pow(m[l][o],2);if(F<i)v=0;else for(p=m[o][o],v=p<0?Math.sqrt(F):-Math.sqrt(F),d=p*v-F,m[o][o]=p-v,l=f;l<a;l++){for(F=0,c=o;c<h;c++)F+=m[c][o]*m[c][l];for(p=F/d,c=o;c<h;c++)m[c][l]=m[c][l]+p*m[c][o]}for(M[o]=v,F=0,l=f;l<a;l++)F+=Math.pow(m[o][l],2);if(F<i)v=0;else{for(p=m[o][o+1],v=p<0?Math.sqrt(F):-Math.sqrt(F),d=p*v-F,m[o][o+1]=p-v,l=f;l<a;l++)C[l]=m[o][l]/d;for(l=f;l<h;l++){for(F=0,c=f;c<a;c++)F+=m[l][c]*m[o][c];for(c=f;c<a;c++)m[l][c]=m[l][c]+F*C[c]}}w=Math.abs(M[o])+Math.abs(C[o]),w>E&&(E=w)}if(s)for(o=a-1;o>=0;o--){if(v!==0){for(d=m[o][o+1]*v,l=f;l<a;l++)A[l][o]=m[o][l]/d;for(l=f;l<a;l++){for(F=0,c=f;c<a;c++)F+=m[o][c]*A[c][l];for(c=f;c<a;c++)A[c][l]=A[c][l]+F*A[c][o]}}for(l=f;l<a;l++)A[o][l]=0,A[l][o]=0;A[o][o]=1,v=C[o],f=o}if(r){if(r==="f")for(o=a;o<h;o++){for(l=a;l<h;l++)m[o][l]=0;m[o][o]=1}for(o=a-1;o>=0;o--){for(f=o+1,v=M[o],l=f;l<S;l++)m[o][l]=0;if(v!==0){for(d=m[o][o]*v,l=f;l<S;l++){for(F=0,c=f;c<h;c++)F+=m[c][o]*m[c][l];for(p=F/d,c=o;c<h;c++)m[c][l]=m[c][l]+p*m[c][o]}for(l=o;l<h;l++)m[l][o]=m[l][o]/v}else for(l=o;l<h;l++)m[l][o]=0;m[o][o]=m[o][o]+1}}n=n*E;var P;for(c=a-1;c>=0;c--)for(var T=0;T<50;T++){for(P=!1,f=c;f>=0;f--){if(Math.abs(C[f])<=n){P=!0;break}if(Math.abs(M[f-1])<=n)break}if(!P){for(u=0,F=1,g=f-1,o=f;o<c+1&&(p=F*C[o],C[o]=u*C[o],!(Math.abs(p)<=n));o++)if(v=M[o],M[o]=Math.sqrt(p*p+v*v),d=M[o],u=v/d,F=-p/d,r)for(l=0;l<h;l++)w=m[l][g],y=m[l][o],m[l][g]=w*u+y*F,m[l][o]=-w*F+y*u}if(y=M[c],f===c){if(y<0&&(M[c]=-y,s))for(l=0;l<a;l++)A[l][c]=-A[l][c];break}for(E=M[f],w=M[c-1],v=C[c-1],d=C[c],p=((w-y)*(w+y)+(v-d)*(v+d))/(2*d*w),v=Math.sqrt(p*p+1),p=((E-y)*(E+y)+d*(w/(p<0?p-v:p+v)-d))/E,u=1,F=1,o=f+1;o<c+1;o++){if(v=C[o],w=M[o],d=F*v,v=u*v,y=Math.sqrt(p*p+d*d),C[o-1]=y,u=p/y,F=d/y,p=E*u+v*F,v=-E*F+v*u,d=w*F,w=w*u,s)for(l=0;l<a;l++)E=A[l][o-1],y=A[l][o],A[l][o-1]=E*u+y*F,A[l][o]=-E*F+y*u;if(y=Math.sqrt(p*p+d*d),M[o-1]=y,u=p/y,F=d/y,p=u*v+F*w,E=-F*v+u*w,r)for(l=0;l<h;l++)w=m[l][o-1],y=m[l][o],m[l][o-1]=w*u+y*F,m[l][o]=-w*F+y*u}C[f]=0,C[c]=p,M[c]=E}for(o=0;o<a;o++)M[o]<n&&(M[o]=0);return{u:m,q:M,v:A}};class or extends Array{constructor(t,r){super(t),this.rows=t,this.cols=r;const s=new Float64Array(t*r);for(let n=0;n<t;n++)this[n]=new Float64Array(s.buffer,n*r*8,r)}}function ir(e,t){const r=t.length,s=t[0].length;for(let n=0;n<r;n++)for(let i=0;i<s;i++)e[i][n]=t[n][i]}function ar(e){for(let t=0,r=e.length;t<r;t++)for(let s=0,n=e.length;s<n;s++)e[t][s]=t===s?1:0}function lr(e){ce(e,0)}function ce(e,t){for(let r=0,s=e.length;r<s;r++)e[r].fill(t)}function cr(e,t,r){for(let s=0,n=e.length;s<n;s++)for(let i=0,a=e.length;i<a;i++)e[s][i]=t[s][i]*r}function hr(e,t,r){if(t===e||r===e)throw new Error("Matrix: Cannot multiply to a matrix in place.");const s=t.length,n=r.length,i=r[0].length;for(let a=0,h=s;a<h;a++)for(let o=0,l=i;o<l;o++){let c=0;for(let f=0,g=n;f<g;f++)c+=t[a][f]*r[f][o];e[a][o]=c}}function he(e,t){return new or(e,t)}function fe(e,t){const r=t.length,s=t[0].length;for(let n=0;n<r;n++)for(let i=0;i<s;i++)e[n][i]=t[n][i]}function fr(e){const t=e.length,r=e[0].length,s=he(t,r);return fe(s,e),s}function dr(e,t,r){const s=le.solve(t,r);for(let n=0,i=s.length;n<i;n++)e[n].set(s[n])}function ur(e,t,r,s){const{u:n,v:i,q:a}=nr(s),h=n.length;for(let c=0;c<h;c++)e[c].set(n[c]);const o=i.length;for(let c=0;c<o;c++)r[c].set(i[c]);const l=a.length;for(let c=0;c<l;c++)t[c][c]=a[c]}function vr(e,t){const r=le.invert(t),s=t[0].length,n=t.length;for(let i=0;i<s;i++)for(let a=0;a<n;a++)e[i][a]=r[i][a]}function pr(e,t,r){const s=t.length,n=t[0].length;for(let i=0;i<s;i++)for(let a=0;a<n;a++)e[i][a]=t[i][a]+r[i][a]}function gr(e,t,r){const s=t.length,n=t[0].length;for(let i=0;i<s;i++)for(let a=0;a<n;a++)e[i][a]=t[i][a]-r[i][a]}function de(e){let t=0;const r=e.length,s=e[0].length;for(let n=0;n<r;n++)for(let i=0;i<s;i++)t+=e[n][i]**2;return t}function mr(e){return Math.sqrt(de(e))}function ue(e,t=3){const r=e.length,s=e[0].length;let n="";for(let i=0;i<r;i++){for(let a=0;a<s;a++)n+=e[i][a].toFixed(t)+", ";n+=`
`}return n}function Fr(e,t){console.log(ue(e,t))}function wr(e,t,r){return e[t][r]}function yr(e,t,r,s){e[t][r]=s}function ve(e,t){return e.length===t.length&&e[0].length===t[0].length}function Er(e,t){if(!ve(e,t))return!1;const r=e.length,s=e[0].length;for(let n=0;n<r;n++)for(let i=0;i<s;i++)if(e[n][i]!==t[n][i])return!1;return!0}function Cr(e,t,r,s){if(e.rows<r||e.cols<s||t.rows<r||t.cols<s)throw new Error("copySubMatrix: matrix dimensions insufficient");for(let n=0;n<r;n++)for(let i=0;i<s;i++)e[n][i]=t[n][i]}function xr(e,t,r,s){if(e.rows<r||e.cols<s||t.rows<r||t.cols<s)return!1;for(let n=0;n<r;n++)for(let i=0;i<s;i++)if(e[n][i]!==t[n][i])return!1;return!0}const x={copySubMatrix:Cr,equalSubMatrix:xr,equal:Er,sameDimensions:ve,transpose:ir,identity:ar,zero:lr,fill:ce,scale:cr,multiply:hr,create:he,copy:fe,clone:fr,solve:dr,svd:ur,invert:vr,add:pr,subtract:gr,magnitudeSquared:de,magnitude:mr,toString:ue,log:Fr,get:wr,set:yr},R=new Float64Array(3),k=new Float64Array(3),tt=new Float64Array(3);function pe(e,t,r,s=null,n={isConverged:!1,rowCount:6,totalError:0}){const{translationConvergeThreshold:i,rotationConvergeThreshold:a,translationErrorClamp:h,rotationErrorClamp:o,translationFactor:l,rotationFactor:c}=e,{translationDoFCount:f,rotationDoFCount:g,dofFlags:u,dof:p}=t;t.getClosureError(R,k);let v=6;t.isGoal&&(R[0]*=u[0],R[1]*=u[1],R[2]*=u[2],v=f,g===0?(k[0]=0,k[1]=0,k[2]=0):v+=3);let d=!1,F=0;const E=ft(R),w=ft(k);if(E<i&&w<a&&(d=!0),F+=E+w,s)if(E>h&&X(R,R,h/E),X(R,R,l),w>o&&X(k,k,o/w),X(k,k,c),t.isGoal){for(let y=0;y<f;y++){const C=p[y];x.set(s,r+y,0,R[C])}g>0&&(x.set(s,r+f+0,0,k[0]),x.set(s,r+f+1,0,k[1]),x.set(s,r+f+2,0,k[2]))}else x.set(s,r+0,0,R[0]),x.set(s,r+1,0,R[1]),x.set(s,r+2,0,R[2]),x.set(s,r+3,0,k[0]),x.set(s,r+4,0,k[1]),x.set(s,r+5,0,k[2]);return n.totalError=F,n.isConverged=d,n.rowCount=v,n}function ge(e,t,r,s=null,n={isConverged:!1,rowCount:6,totalError:0}){const{translationConvergeThreshold:i,rotationConvergeThreshold:a,lockedJointDoFCount:h,translationErrorClamp:o,rotationErrorClamp:l,lockedJointDoF:c}=e,{dofTarget:f,dofValues:g,translationDoFCount:u,rotationDoFCount:p,translationFactor:v,rotationFactor:d,dofList:F}=t,E=Pe(g,f);let w=f[D.EX]-g[D.EX]+f[D.EY]-g[D.EY]+f[D.EZ]-g[D.EZ];const y=h.get(t)||0;if(n.rowCount=u+p-y,n.isConverged=E<i&&w<a,n.totalError=E+w,s){const C=c.get(t),m=y!==0;let A=0;R[0]=f[0]-g[0],R[1]=f[1]-g[1],R[2]=f[2]-g[2];const S=ft(R);X(R,R,v*o/S);for(let P=0,T=u;P<T;P++){const W=F[P];m&&C[W]||(x.set(s,r+A,0,R[W]),A++)}tt[0]=t.dofTarget[3]-t.dofValues[3],tt[1]=t.dofTarget[4]-t.dofValues[4],tt[2]=t.dofTarget[5]-t.dofValues[5];const M=ft(tt);X(tt,tt,d*l/M);for(let P=u,T=u+p;P<T;P++){const W=F[P];m&&C[W]||(x.set(s,r+A,0,tt[W-3]),A++)}}}const Q=new Float64Array(3),K=new Float64Array(3),me=new Float64Array(3),Fe=new Float64Array(3),At=new Float64Array(3),we=new Float64Array(3),ye=new Float64Array(4),vt=[],et=[],b={rowCount:0,isConverged:!1,totalError:0},Ee={errorRows:0,freeDoF:0,totalError:0},lt={CONVERGED:0,STALLED:1,DIVERGED:2,TIMEOUT:3};Object.entries(lt).sort((e,t)=>e[1]-t[1]).map(e=>e[0]);class Dr{constructor(t){this.chain=Array.from(t),this.targets=null,this.affectedClosures=null,this.affectedConnectedClosures=null,this.lockedJointDoFCount=null,this.lockedJointDoF=null,this.prevDoFValues=null,this.maxIterations=-1,this.matrixPool=null,this.useSVD=!1,this.translationConvergeThreshold=-1,this.rotationConvergeThreshold=-1,this.translationFactor=-1,this.rotationFactor=-1,this.translationErrorClamp=-1,this.rotationErrorClamp=-1,this.stallThreshold=-1,this.dampingFactor=-1,this.divergeThreshold=-1,this.restPoseFactor=-1,this.prevJacobian=x.create(0,0),this.prevPseudoInverse=x.create(0,0),this.init()}init(){const t=this.chain,r=t.filter(o=>o.targetSet||o.isClosure),s=new Map,n=new Map,i=new Map,a=new Map,h=new Map;t.forEach(o=>{a.set(o,new Set),h.set(o,new Set),s.set(o,new Uint8Array(6)),i.set(o,new Float64Array(6))}),r.forEach(o=>{if(o.isClosure){let l=o;for(;l;)l.isJoint&&a.get(l).add(o),l=l.parent;for(l=o.child;l;)l.isJoint&&h.get(l).add(o),l=l.parent}}),this.targets=r,this.affectedClosures=a,this.affectedConnectedClosures=h,this.lockedJointDoF=s,this.lockedJointDoFCount=n,this.prevDoFValues=i}solve(){const{divergeThreshold:t,stallThreshold:r,chain:s,restPoseFactor:n,lockedJointDoFCount:i,prevDoFValues:a,useSVD:h,matrixPool:o,dampingFactor:l,maxIterations:c}=this,f=this.translationErrorClamp,g=this.rotationErrorClamp;let u=1,p=0,v=1/0,d=-1;i.clear();for(let F=0,E=s.length;F<E;F++){const w=s[F];(w.targetSet||w.restPoseSet)&&w.tryMinimizeEulerAngles()}do{o.releaseAll();for(let S=0,M=s.length;S<M;S++)s[S].updateMatrixWorld();vt.length=0,et.length=0,this.countUnconvergedVariables(et,vt,Ee);const{freeDoF:F,errorRows:E,totalError:w}=Ee;if(E===0){d=lt.CONVERGED;break}if(w>v+t){if(a.forEach((S,M)=>{M.dofValues.set(S),M.setMatrixDoFNeedsUpdate(),M.updateMatrixWorld()}),u*=.5,this.translationErrorClamp=f*u,this.rotationErrorClamp=g*u,u<.5**6||p>c){d=lt.DIVERGED;break}}else v=w,a.forEach((S,M)=>{S.set(M.dofValues)});if(p>c){d=lt.TIMEOUT;break}const y=o.get(E,1);this.fillErrorVector(vt,y);const C=o.get(E,F);this.fillJacobian(vt,et,C);const m=o.get(F,E);if(this.jacobianCacheEquals(C))this.restorePseudoInverse(m);else{let S=!1;if(h)try{const M=E,P=F,T=Math.min(M,P),W=o.get(M,T),V=o.get(T,T),J=o.get(P,T);x.svd(W,V,J,C);const N=o.get(T,M),U=o.get(T,T);x.transpose(N,W);const rt=l**2;for(let Y=0,zt=V.length;Y<zt;Y++){const pt=x.get(V,Y,Y),qt=pt/(pt*pt+rt);x.set(U,Y,Y,qt)}const Jt=o.get(P,T);x.multiply(Jt,J,U),x.multiply(m,Jt,N)}catch{S=!0}if(!h||S){const M=o.get(E,E);x.identity(M),x.scale(M,M,this.dampingFactor**2);const P=o.get(F,E);x.transpose(P,C);const T=o.get(E,E);x.multiply(T,C,P);const W=o.get(E,E);x.add(W,T,M);const V=o.get(E,E);x.invert(V,W),x.multiply(m,P,V)}this.cacheJacobianResult(C,m)}const A=o.get(F,1);if(x.multiply(A,m,y),n!==0){const S=o.get(F,1),M=o.get(F,1);let P=0;for(let V=0,J=et.length;V<J;V++){const N=et[V],U=this.lockedJointDoFCount.get(N)||0,rt=U!==0,Jt=this.lockedJointDoF.get(N),Y=N.rotationDoFCount+N.translationDoFCount-U;if(N.restPoseSet){const zt=N.dof,pt=N.dofValues,qt=N.dofRestPose;for(let It=0;It<Y;It++){const _t=zt[It];rt&&Jt[_t]||(x.set(S,P,0,qt[_t]-pt[_t]),P++)}}else P+=Y}const T=o.get(E,1);x.multiply(T,C,S);const W=o.get(F,1);x.multiply(W,m,T),x.subtract(M,S,W);for(let V=0;V<F;V++){const J=x.get(M,V,0);x.set(A,V,0,x.get(A,V,0)+J*n)}}if(r>0){let S=!0;for(let M=0,P=A.length;M<P;M++){const T=x.get(A,M,0);if(Math.abs(T)>r){S=!1;break}}if(S){d=lt.STALLED;break}}this.applyJointAngles(et,A),p++}while(!0);return this.translationErrorClamp=f,this.rotationErrorClamp=g,vt.length=0,et.length=0,d}applyJointAngles(t,r){const{lockedJointDoF:s,lockedJointDoFCount:n}=this;let i=!1,a=0;for(let h=0,o=t.length;h<o;h++){const l=t[h],c=l.dof,f=s.get(l),g=n.has(l);for(let u=0,p=c.length;u<p;u++){const v=c[u];if(g&&f[v])continue;const d=l.getDoFValue(v);if(l.setDoFValue(v,d+x.get(r,a,0))){n.has(l)||(n.set(l,0),f.fill(0));const E=n.get(l);n.set(l,E+1),f[v]=1,i=!0}a++}}if(a!==r.length)throw new Error;return i}fillJacobian(t,r,s){const{lockedJointDoF:n,lockedJointDoFCount:i,translationFactor:a,rotationFactor:h}=this,o=this.affectedClosures,l=this.affectedConnectedClosures;let c=0;for(let f=0,g=r.length;f<g;f++){const u=r[f],p=o.get(u),v=l.get(u),d=u.dof,F=u.translationDoFCount+u.rotationDoFCount,E=u.cachedIdentityDoFMatrixWorld,w=i.has(u),y=n.get(u);for(let C=0;C<F;C++){const m=d[C];if(w&&y[m])continue;let A=0;for(let S=0,M=t.length;S<M;S++){const P=t[S];if(P.isClosure)if(p.has(P)||v.has(P)){const T=v.has(P);if(G(ye,E),We(At,Oe[m],ye),m<3)st(K,At),Q[0]=0,Q[1]=0,Q[2]=0;else{const V=T?P.child.matrixWorld:P.matrixWorld;$(Fe,V),$(me,E),Yt(we,Fe,me),mt(K,At,we),st(Q,At)}const W=T?1:-1;if(X(K,K,W*a),X(Q,Q,W*h),P.isGoal){const{translationDoFCount:V,rotationDoFCount:J,dof:N}=P;for(let U=0;U<V;U++){const rt=N[U];x.set(s,A+U,c,K[rt])}for(let U=0;U<J;U++){const rt=N[V+U];x.set(s,A+V+U,c,Q[rt-3])}A+=V+J}else x.set(s,A+0,c,K[0]),x.set(s,A+1,c,K[1]),x.set(s,A+2,c,K[2]),x.set(s,A+3,c,Q[0]),x.set(s,A+4,c,Q[1]),x.set(s,A+5,c,Q[2]),A+=6}else P.isGoal?A+=P.translationDoFCount+P.rotationDoFCount:A+=6;if(P.targetSet){const T=P.translationDoFCount+P.rotationDoFCount;if(u===P)for(let W=0;W<T;W++)x.set(s,A+c,c,-1);A+=T}}c++}}if(c!==s[0].length)throw new Error}fillErrorVector(t,r){let s=0;for(let n=0,i=t.length;n<i;n++){const a=t[n];a.isClosure&&(pe(this,a,s,r,b),s+=b.rowCount),a.targetSet&&(ge(this,a,s,r,b),s+=b.rowCount)}}countUnconvergedVariables(t,r,s){const{lockedJointDoFCount:n}=this,i=this.chain;let a=0,h=0,o=0,l=0;for(let c=0,f=i.length;c<f;c++){let g=!1;const u=i[c],p=n.get(u)||0;u.isClosure&&(pe(this,u,h,null,b),b.isConverged||(o+=b.rowCount,a+=b.totalError),g=!0,h+=b.rowCount);const v=u.dof;u.targetSet&&(ge(this,u,h,null,b),b.isConverged||(o+=b.rowCount,a+=b.totalError),g=!0,h+=b.rowCount),!u.isGoal&&v.length>0&&(l+=v.length-p,t.push(u)),g&&r.push(u)}o===0&&(h=0),s.errorRows=h,s.freeDoF=l,s.totalError=a}jacobianCacheEquals(t){return x.equalSubMatrix(this.prevJacobian,t,t.rows,t.cols)}restorePseudoInverse(t){x.copySubMatrix(t,this.prevPseudoInverse,t.rows,t.cols)}cacheJacobianResult(t,r){const{rows:s,cols:n}=t;(this.prevJacobian.rows<s||this.prevJacobian.cols<n)&&(this.prevJacobian=x.create(s,n)),(this.prevPseudoInverse.rows<r.rows||this.prevPseudoInverse.cols<r.cols)&&(this.prevPseudoInverse=x.create(r.rows,r.cols)),x.fill(this.prevJacobian,1/0),x.fill(this.prevPseudoInverse,1/0),x.copySubMatrix(this.prevJacobian,t,s,n),x.copySubMatrix(this.prevPseudoInverse,r,r.rows,r.cols)}}function Mr(e){const t=e.map(n=>{let i=n;return n.traverseParents(a=>{i=a}),i}),r=[],s=new Set;for(let n=0;n<t.length;n++){const i=t[n];s.has(i)||(r.push(i),i.traverse(a=>{if(s.has(a))return!0;s.add(a);let h;a.isLink?h=a.closureJoints:a.isJoint&&a.isClosure&&(h=[a.child]),h&&h.forEach(o=>{let l=o;o.traverseParents(c=>{l=c}),s.has(l)||t.push(l)})}))}return r}class Ar{constructor(t,r){const s=[];let n=0;this.get=function(){let i=s[n];return i?x.zero(i):s[n]=i=x.create(t,r),n++,i},this.releaseAll=function(){n=0}}}class Pr{constructor(){const t={},r=[];this.get=function(s,n){let i=t[s];i||(i=t[s]={});let a=i[n];return a||(a=i[n]=new Ar(s,n),r.push(a)),a.get()},this.releaseAll=function(){for(let s=0,n=r.length;s<n;s++)r[s].releaseAll()}}}class Tr{constructor(t=[]){this.matrixPool=new Pr,this.useSVD=!1,this.maxIterations=5,this.stallThreshold=1e-4,this.dampingFactor=.001,this.divergeThreshold=.01,this.restPoseFactor=.01,this.translationConvergeThreshold=.001,this.rotationConvergeThreshold=1e-5,this.translationFactor=1,this.rotationFactor=1,this.translationErrorClamp=.1,this.rotationErrorClamp=.1,this.roots=Array.isArray(t)?[...t]:[t],this.solvers=null,this.updateStructure()}updateStructure(){const t=Mr(this.roots),r=[],s=new Set,n=new Set,i=o=>{if(o.isJoint){const c=o;if(s.add(c),c.isClosure){const f=new Set;let g=c.child;for(;g;){if(g.isJoint){if(s.has(g))break;f.add(g),n.add(g)}g=g.parent}s.forEach(u=>{f.add(u),n.add(u)}),r.push(f)}}const l=o.children;for(let c=0,f=l.length;c<f;c++)i(l[c]);s.delete(o)};t.forEach(i);const a=[];for(;r.length;){const o=r.pop();a.push(o);for(let l=0;l<r.length;l++){const c=r[l];let f=!1;c.forEach(g=>{f=f||o.has(g)}),f&&(c.forEach(g=>o.add(g)),r.splice(l,1),l--)}}const h=new Set;t.forEach(o=>o.traverse(l=>{l.isJoint&&l.dof.length>0&&!n.has(l)&&h.add(l)})),this.solvers=a.map(o=>new Dr(o)),this.nonChainJoints=h}solve(){const{solvers:t,nonChainJoints:r}=this;r.forEach(n=>{n.targetSet&&(n.dofValues.set(n.dofTarget),n.setMatrixDoFNeedsUpdate())});const s=[];for(let n=0,i=t.length;n<i;n++){const a=t[n];a.matrixPool=this.matrixPool,a.useSVD=this.useSVD,a.maxIterations=this.maxIterations,a.stallThreshold=this.stallThreshold,a.dampingFactor=this.dampingFactor,a.divergeThreshold=this.divergeThreshold,a.restPoseFactor=this.restPoseFactor,a.translationConvergeThreshold=this.translationConvergeThreshold,a.rotationConvergeThreshold=this.rotationConvergeThreshold,a.translationFactor=this.translationFactor,a.rotationFactor=this.rotationFactor,a.translationErrorClamp=this.translationErrorClamp,a.rotationErrorClamp=this.rotationErrorClamp;const h=a.solve();s.push(h)}return s}}class Sr extends Bt{constructor(){super(),this.isLink=!0,this.closureJoints=[]}addChild(t){if(t.isJoint)super.addChild(t);else throw new Error("Link: Added child must be a Joint.")}}class Vr extends ie{constructor(...t){super(...t),this.isGoal=!0,this.setFreeDoF()}setDoF(...t){let r=Number(t.includes(D.EX))+Number(t.includes(D.EY))+Number(t.includes(D.EZ));if(r!==0&&r!==3)throw new Error("Goal: Only full 3 DoF or 0 DoF rotation goals are supported.");super.setDoF(...t)}setGoalDoF(...t){this.setDoF(...t)}setFreeDoF(...t){const r=[D.X,D.Y,D.Z,D.EX,D.EY,D.EZ].filter(s=>!t.includes(s));this.setDoF(...r)}addChild(){throw new Error("Goal: Cannot add children to Goal.")}}function Jr(e){const t=e.map(r=>{const{type:s,name:n,position:i,quaternion:a,dof:h,dofValues:o,dofTarget:l,dofRestPose:c,minDoFLimit:f,maxDoFLimit:g,targetSet:u,restPoseSet:p,isClosure:v}=r;let d;switch(s){case"Goal":case"Joint":d=s==="Goal"?new Vr:new ie,d.setDoF(...h),d.dofValues.set(o),d.dofTarget.set(l),d.dofRestPose.set(c),d.minDoFLimit.set(f),d.maxDoFLimit.set(g),d.targetSet=u,d.restPoseSet=p,d.isClosure=v;break;case"Link":d=new Sr;break}return d.name=n,d.position.set(i),d.quaternion.set(a),d});for(let r=0;r<t.length;r++){const s=t[r],n=e[r];s.parent=t[n.parent]||null,s.children.push(...n.children.map(i=>t[i])),s.setMatrixNeedsUpdate(),s.isLink&&s.closureJoints.push(...n.closureJoints.map(i=>t[i])),s.isJoint&&(s.child=n.child!==null?t[n.child]:null,s.setMatrixDoFNeedsUpdate())}return t}const Ce=304;function Wr(e,t,r,s=!0,n=!0){for(let i=0,a=e.length;i<a;i++)Rr(e[i],t,r,i*Ce,s,n)}function Lr(e,t,r,s=!0,n=!0){for(let i=0,a=e.length;i<a;i++)kr(e[i],t,r,Ce*i,s,n)}function Rr(e,t,r,s,n=!0,i=!0){const a=s/4;if(i){const{position:h,quaternion:o}=e;for(let l=0;l<3;l++)t[a+0+l]=h[l];for(let l=0;l<4;l++)t[a+3+l]=o[l];if(e.isJoint){const{dofTarget:l,dofRestPose:c,minDoFLimit:f,maxDoFLimit:g,targetSet:u,restPoseSet:p}=e;for(let v=0;v<6;v++)t[a+7+0+v]=l[v],t[a+7+6+v]=c[v],t[a+7+12+v]=f[v],t[a+7+18+v]=g[v];r[s+148]=Number(u),r[s+149]=Number(p)}}if(n&&e.isJoint){const{dofValues:h}=e;for(let o=0;o<6;o++)t[a+7+24+o]=h[o]}}function kr(e,t,r,s,n=!0,i=!0){const a=s/4;if(i&&(e.setPosition(t[a+0],t[a+1],t[a+2]),e.setQuaternion(t[a+3+0],t[a+3+1],t[a+3+2],t[a+3+3]),e.isJoint)){const{dofTarget:h,dofRestPose:o,minDoFLimit:l,maxDoFLimit:c}=e;for(let f=0;f<6;f++)h[f]=t[a+7+0+f],o[f]=t[a+7+6+f],l[f]=t[a+7+12+f],c[f]=t[a+7+18+f];e.targetSet=!!r[s+148],e.restPoseSet=!!r[s+149]}if(n&&e.isJoint){const{dofValues:h}=e;let o=!1;for(let l=0;l<6;l++){const c=t[a+7+24+l];c!==h[l]&&(h[l]=c,o=!0)}o&&e.setMatrixDoFNeedsUpdate()}}const Ur=typeof SharedArrayBuffer<"u";let Pt=new Tr,ct=-1,Tt=null,St=null,Nt=null,Vt=null;self.onmessage=function({data:e}){const{type:t,data:r}=e;switch(t){case"updateStructure":Tt=Jr(r.serialized),Pt.roots=Tt.filter(s=>s.parent===null),Pt.updateStructure(),St=r.buffer,Vt=new Uint8Array(St),Nt=new Float32Array(St);break;case"updateFrameState":Vt.set(new Uint8Array(r.buffer));break;case"updateSolverSettings":Object.assign(Pt,r);break;case"startSolve":ct===-1&&xe();break;case"endSolve":ct!==-1&&(clearTimeout(ct),ct=-1);break}};function xe(){Lr(Tt,Nt,Vt,!1,!0);const e=Pt.solve();if(Wr(Tt,Nt,Vt,!0,!1),e.find(t=>t===lt.TIMEOUT)?ct=setTimeout(xe):ct=-1,Ur)self.postMessage({type:"updateSolve",data:{status:e}});else{const t=St.slice();self.postMessage({type:"updateSolve",data:{status:e,buffer:t}},[t])}}})();
